!function(){var e;chrome.runtime&&chrome.runtime.getManifest&&(b=chrome.runtime.getManifest().version),e={settingsFile:"settings.json"};var t=["ru","en","en_US"],r=[{lang:"ru",name:"Русский"},{lang:"en",name:"English"}],n="ru",a=["RUB","USD","EUR"],i=[{curr:"RUB",name:"Рубль"},{curr:"USD",name:"USD"},{curr:"EUR",name:"Euro"}],o="RUB";$.ajaxSetup({timeout:6e4});var s=function(e){return e?chrome.i18n.getMessage(e):""};try{"en"===chrome.i18n.getMessage("@@ui_locale").split("_")[0]&&(o="USD")}catch(e){}function c(e){return"object"==typeof e}function u(){performance&&performance.now&&(this.timer||(this.timer=performance.now())),this.showTime=function(e){this.timer=performance.now()}}function l(e){var t="USD",r=e.cur||e.app_cur;if(+r){var n={1:"USD",2:"RUB",3:"AUD",4:"EUR",5:"MXN",6:"UAH",7:"CAD",8:"TRY",9:"CLP",10:"SGD",11:"CHF",12:"BRL",13:"INR",14:"JPY",15:"IDR",16:"KRW",17:"NZD",18:"SEK"};t=n[r]?n[r]:"USD"}else t=r;return t}function d(e,t,r,n){var a="",i='<span class="curr">',o="</span>",s=!!n&&2;switch(r&&(i="",o=""),e){case"RUB":t<1?(s=!!n&&1,a=c(Math.round(10*t)/10)):(s=!1,a=c(Math.round(t))),a+=" "+i+"р."+o;break;case"GBP":a=i+"£ "+o+c(t);break;case"JPY":a=i+"¥ "+o+c(t);break;case"TRY":a=i+"TL "+o+c(t);break;case"BRL":case"MXN":case"AUD":case"CAD":case"USD":a=i+"$"+o+c(t);break;case"UAH":s=!!n&&1,a=c(Math.round(10*t)/10)+" "+i+"грн"+o;break;case"EUR":a=i+"€ "+o+c(t);break;default:s=!!n&&1,a=i+"$"+o+c(t)}return c(t)?a:"";function c(e){var t="";if(e){!1!==s&&+e&&+e<99999&&(e=(+e).toFixed(s));var r=e.toString().split(".");r&&(t=r[0].replace(/(\d{1,3}(?=(?:\d\d\d)+(?!\d)))/g,"$1 ")+(void 0!==r[1]?"."+r[1]:""))}return t}}function m(e,t){void 0!==e.item.sale_price&&+e.item.sale_price>0?e.item.sale_price:e.item.original_price;var r=0,n=(new Date).setHours(0,0,0,0),a=n,i=function(e){var t=[],r=[];r=e.item&&e.item.customHistory?e.item.customHistory:e.history?e.history:[];var n,a,i=0;if($.each(r,function(e,o){var s,c,u,d;if(s=o.sale_price||o.original_price||o.price,c=o.date||o.created_at,u=+o.currency_rate,0==+s||!c||r.length>3&&n===s&&a===new Date(c).setHours(0,0,0,0))return!0;n=s,a=new Date(c).setHours(0,0,0,0),d={price:s,date:c,cur:l(o)},u&&(d.currency_rate=u),o.cached&&(d.cached=o.cached),t.push(d),i++}),1===i&&t[0]&&t[0].price){var o=t[0],s=new Date(o.date);s.setDate(s.getDate()-2),t.push({price:o.price,date:s,cur:o.cur}),i++}return t}(e),o=0,c=!1;if($.each(i,function(e,t){var s,u,l=new Date(Date.parse(t.date)).setHours(0,0,0,0);if(s=+t.price,u=void 0!==i[e+1]&&+i[e+1].price?+i[e+1].price:s,a=new Date(Date.parse(t.date)).getTime(),t.cached&&(c=!0),r=Math.floor((n-l)/864e5),u!==s)return o=Math.round(100*(s-u))/100,!1}),0!==o||i&&i.length||!e||!e.item||!e.item.priceChange||0===e.item.priceChange||(o=e.item.priceChange),t)return{priceChange:o};var u="",d="",m="";return r>1&&r<7?d=r+" "+p(r,[f("i_history_day_1"),f("i_history_day_2"),f("i_history_day_3")]):r>=7&&r<14?d=f("i_history_week"):r>=14&&r<21?d=f("i_history_two_weeks"):r>=21&&r<31?d=f("i_history_hree_weeks"):r>31&&(d=f("i_history_more_than_month")),o>0||o<0?(o>0&&(m+=" "+f("c_price_tooltip_up")+" "),o<0&&(m+=" "+f("c_price_tooltip_down")+" "),r<=1?(o>0&&(u=f("i_history_up")+" "),o<0&&(u=f("i_history_down")+" "),0===r&&(d=f("i_history_today")),1===r&&(d=f("i_history_yesterday"))):r>1&&r<31?d+=" "+f("i_history_ago"):r>31&&(d=f("i_history_more_than_month"))):(u=f("i_history_none_small")+" ",r>31&&(u=""),m+=" "+f("c_price_tooltip_not_changed2")),{priceChangeTimestamp:a,priceChangeText:u+d,priceChangeTooltipTxt:m,priceChange:o,priceFromCache:c};function f(e){return s(e)}}function p(e,t,r){var n="";return n=e%10==1&&e%100!=11?t[0]:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?t[1]:t[2],r?n.replace("_",e):n}function f(e,t,r){var n=e/((e>0?+t-Math.abs(e):+t+Math.abs(e))/100),a=Math.abs(Math.round(10*n.toFixed(1))/10);return r?a+"%":a}chrome.storage&&chrome.storage.local.get({uiCurrency:!1},function(e){!1===e.uiCurrency||-1===a.indexOf(e.uiCurrency)?chrome.storage.local.set({uiCurrency:o}):o=e.uiCurrency,$(".select-row--uiCurrency select").html(""),$.each(i,function(e,t){-1!==a.indexOf(t.curr)&&$(".select-row--uiCurrency select").append('<option value="'+t.curr+'" '+(o===t.curr?" selected":"")+">"+t.name+"</option>")})});var h,g,k,_=!0,b="2.1.9",v=new function(){var e=this;e.localData={settingsJson:!1,settingsJsonTimeout:!1,tracking_id:!1,tracking_idTimeout:!1,installed:!1,installTimestamp:!1,redirectsDisabled:!1,hideLinksInPopup:!1,trialPeriod:!1,utm_url:!1,extensionId:!1,sk:!1,skData:!1,skTimeout:!1,cachedPrices:!1,exceptionsJsonFirstLoad:!1,exceptionsJson:!1,exceptionsOtherData:!1,youtubeExceptionsJson:!1,clearUrlParams:!1,exceptionsJsonTimeout:!1,apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1,clickId:!1,lastVisitTrackDate:!1,cashbackId:!1,cashbackSkMatched:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackUser:!1,lastPromotionSet:!1,lastTmallPromotionSet:!1,importantDataCheckFirst:!1,notificationExpires:!1,currencyRates:!1,currencyLoadTimeout:!1},e.init=function(t){var r=new u;return void 0!==e.result&&"rejected"!==e.result.state()?e.result.promise():(e.result=$.Deferred(),chrome.storage.onChanged.addListener(function(t,r){if("local"!==r)return!1;for(var n in t){var a=t[n];void 0!==e.localData[n]&&(e.localData[n]=a.newValue)}}),chrome.storage.local.get(e.localData,function(t){$.each(t,function(t,r){e.localData[t]=r}),r.showTime("AliHelperStorage inited: "),e.result.resolve()}),e.result.promise())},e.get=function(t,r){var n={},a={};if($.each(t,function(t,r){void 0!==e.localData[t]?n[t]=e.localData[t]:a[t]=r}),0===Object.keys(a).length)return r(n),!1;chrome.storage.local.get(a,function(e){if(chrome.runtime.lastError)return!1;$.each(e,function(e,t){n[e]=t}),r&&r(n)})},e.set=function(t,r){if(chrome.runtime.lastError)return!1;$.each(t,function(t,r){void 0!==e.localData[t]&&(e.localData[t]=r)}),chrome.storage.local.set(t,function(){r&&r()})}},y=new function(){var e=this;e.inited=!1,e.init=function(t){L().done(function(r,n){if(!r)return!1;e.reinit(r,n,t||!e.inited).done(function(){}),e.inited=!0})},e.reinit=function(c,l,d){var m=new u,p=$.Deferred();return O().done(function(u){if(!1===u)return!1;if(e.dataArray={stat:{masks:[],sk:[]},disable:{masks:[],sk:[]}},c){if(c.data_for_stat){var f=c.data_for_stat;void 0!==f.masks&&$.each(f.masks,function(t,r){e.dataArray.stat.masks.push("*://*."+r.val+"*")}),void 0!==f.sk&&$.each(f.sk,function(t,r){e.dataArray.stat.sk.push(r.val)})}if(c.data_for_disable_redirects){var h=c.data_for_disable_redirects;void 0!==h.masks&&$.each(h.masks,function(t,r){var n="*://*."+r.val+"*";-1===e.dataArray.disable.masks.indexOf(n)&&e.dataArray.disable.masks.push(n)}),void 0!==h.sk&&$.each(h.sk,function(t,r){e.dataArray.disable.sk.push(r.val)})}}var g,k,_;void 0!==chrome.webRequest&&chrome.webRequest&&v.get({cashbackUser:!1},function(t){d&&!1===t.cashbackUser&&chrome.tabs.query({},function(t){var r=!1;$.each(t,function(t,n){if($.each(e.dataArray.disable.masks,function(t,a){var i=a.substr(0,a.length-1).substr(6);if(Q(n.url,i))return e.disableMasksListener(n),r=!0,!1}),r)return!1})}),e.listenersAdded||(e.initCashbackStat(),e.initDisableCashbacks()),m.showTime("Init cashbacks: ")}),g=u,k=l,_=d,e.youtubeExceptions=k&&("string"==typeof k?[k]:k)||[],-1!==g.indexOf("youtube")&&chrome.tabs&&chrome.webNavigation&&(e.youtubeExceptions.length>0?(t||(chrome.runtime.onMessage.addListener(o,function(){}),chrome.webNavigation.onDOMContentLoaded.addListener(n,{url:[{hostSuffix:"youtube.com"}],types:["main_frame"]}),chrome.tabs.onCreated.addListener(a),chrome.tabs.onRemoved.addListener(i),t=!0),_&&!r&&(chrome.tabs.query({url:"*://*.youtube.com/*"},function(e){e&&$.each(e,function(e,t){t&&t.id&&s(t.id)})}),r=!0)):(chrome.webNavigation.onDOMContentLoaded.hasListener(n)&&chrome.webNavigation.onDOMContentLoaded.removeListener(n),chrome.tabs.onCreated.hasListener(a)&&chrome.tabs.onCreated.removeListener(a),chrome.tabs.onRemoved.hasListener(i)&&chrome.tabs.onRemoved.removeListener(i),chrome.runtime.onMessage.hasListener(o)&&chrome.runtime.onMessage.removeListener(o),t=!1)),p.resolve()}),p.promise()},e.initCashbackStat=function(){chrome.webRequest.onBeforeRequest.hasListener(e.statMasksListener)&&chrome.webRequest.onBeforeRequest.removeListener(e.statMasksListener),chrome.webRequest.onBeforeRequest.hasListener(e.statSkListener)&&chrome.webRequest.onBeforeRequest.removeListener(e.statSkListener),e.dataArray.stat.masks.length&&chrome.webRequest.onBeforeRequest.addListener(e.statMasksListener,{urls:e.dataArray.stat.masks,types:["main_frame"]}),e.dataArray.stat.sk.length&&chrome.webRequest.onBeforeRequest.addListener(e.statSkListener,{urls:["*://*.aliexpress.com/*"],types:["main_frame"]})},e.initDisableCashbacks=function(){chrome.webRequest.onBeforeRequest.hasListener(e.disableMasksListener)&&chrome.webRequest.onBeforeRequest.removeListener(e.disableMasksListener),chrome.webRequest.onBeforeRequest.hasListener(e.disableSkListener)&&chrome.webRequest.onBeforeRequest.removeListener(e.disableSkListener),e.dataArray.disable.masks.length&&chrome.webRequest.onBeforeRequest.addListener(e.disableMasksListener,{urls:e.dataArray.disable.masks,types:["main_frame"]}),e.dataArray.disable.sk.length&&chrome.webRequest.onBeforeRequest.addListener(e.disableSkListener,{urls:["*://*.aliexpress.com/*"],types:["main_frame"]})},e.statMasksListener=function(t){if(!t.url)return!1;$.each(e.dataArray.stat.masks,function(e,r){var n,a=r.substr(0,r.length-1).substr(6);Q(t.url,a)&&(n=a,v.get({cashbackUser:!1},function(e){N({type:"cashbackUserStat",message:"stat masks",cashbackInfo:n||t.url,tab_url:t.url,cashbackUser:e.cashbackUser,cashbackInfoType:"mask"})}))})},e.statSkListener=function(t){if(!t.url)return!1;$.each(e.dataArray.stat.sk,function(e,r){-1!==t.url.indexOf(r)&&v.get({cashbackUser:!1},function(e){N({type:"cashbackUserStat",message:"stat sk",cashbackInfo:r,cashbackUser:e.cashbackUser,cashbackInfoType:"sk"})})})},e.disableMasksListener=function(e){if(!e.url)return!1;z(e,function(e){})},e.disableSkListener=function(t){if(!t.url)return!1;$.each(e.dataArray.disable.sk,function(e,r){-1!==t.url.indexOf(r)&&z(t,function(e){})})};var t=!1,r=!1;function n(e){e&&e.tabId&&0===e.frameId&&s(e.tabId)}function a(e){e&&e.id&&e.openerTabId&&c(e.openerTabId)&&!d(e.id)&&(h(e.id,"tabIdsForExceptions"),setTimeout(function(){m(e.id)},1e4))}function i(e){if(!e)return!1;m(e),l(e)}function o(t,r){switch(t.type){case"checkYoutubeException":t.youtubeChannelId&&function(t){if(!t||!t.youtubeChannelId||!t.tabId)return!1;-1!==e.youtubeExceptions.indexOf(t.youtubeChannelId)?c(t.tabId)||(h(r=t.tabId,"tabIdsToCheck"),f(r,"tabIdsForExceptions")):l(t.tabId);var r;t.cb&&t.cb()}({youtubeChannelId:t.youtubeChannelId,tabId:r&&r.tab&&r.tab.id,cb:function(){}});break;case"removeYoutubeExceptionTab":r&&r.tab&&r.tab.id&&l(r.tab.id)}return!0}function s(e){chrome.tabs.executeScript&&e&&chrome.tabs.executeScript(e,{code:"var youtubeContentScript = "+function(){var e,t,r,n=(r=(new Date).getTime(),"undefined"!=typeof performance&&"function"==typeof performance.now&&(r+=performance.now()),"xxxxxx-xxxx-2xxx-yxx-xxxxxx".replace(/[xy]/g,function(e){var t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)})),a=!1;if(document.body.setAttribute("data-helper-check",n),!c())return!1;try{s()&&((t=document.body.innerHTML.match(/"channelId":"([0-9a-zA-Z_-]*)"/g)[0])&&(t=t.split(":")[1]),t&&(e=t.replace(/"/g,"")),e&&(o(e),a=e)),window.addEventListener("yt-navigate-finish",i,!1),window.addEventListener("spfdone",i,!1)}catch(e){}function i(){if(!c())return!1;try{s()?setTimeout(function(){var t=document.getElementById("owner-container");t&&(t=t.querySelector("#owner-name a")),t?(o(t=t.getAttribute("href").replace("/channel/","")),a=t):a&&e()},1e3):a&&e()}catch(e){}function e(){chrome.runtime.sendMessage({type:"removeYoutubeExceptionTab"},function(){chrome.runtime.lastError&&chrome.runtime.lastError.message}),a=!1}}function o(e){(!a||a&&a!==e)&&chrome.runtime.sendMessage({type:"checkYoutubeException",youtubeChannelId:e},function(){chrome.runtime.lastError&&chrome.runtime.lastError.message})}function s(){return-1!==document.location.href.indexOf("watch?v=")}function c(){return void 0!==chrome.runtime.getManifest&&void 0!==chrome.runtime.getManifest()&&document.body.getAttribute("data-helper-check")===n}}.toString()+"; youtubeContentScript();",runAt:"document_end"},function(){chrome.runtime.lastError})}function c(e){return p(e,"tabIdsToCheck")}function l(e){f(e,"tabIdsToCheck")}function d(e){return p(e,"tabIdsForExceptions")}function m(e){f(e,"tabIdsForExceptions")}function p(t,r){return-1!==e[r].indexOf(t)}function f(t,r){p(t,r)&&e[r].splice(e[r].indexOf(t),1)}function h(t,r){p(t,r)||e[r].push(t)}e.tabIdsToCheck=[],e.tabIdsForExceptions=[],e.existYtExceptionTab=function(e){return d(e)},e.removeYtExceptionTab=function(e){m(e)}},x=new function(){var e=this;function t(e){var t="";return e.indexOf("#helper_my_products")>0&&(e.replace("#helper_my_products",""),t="#helper_my_products"),e.indexOf("#helper_howto")>0&&(e.replace("#helper_howto",""),t="#helper_howto"),e.indexOf("#open_price_history")>0&&(e.replace("#open_price_history",""),t="#open_price_history"),{href:e,hash:t}}function r(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxx-yy6yyyyy-yxxxxx-xxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:3&r|8).toString(16)})}function n(t,r){if(void 0===t||!t)return!1;r||(r=e.clearUrlParams.slice(),-1===t.indexOf("/item/")&&-1===t.indexOf("-detail.html")&&-1===t.indexOf("/store/product/")||r.push("pvid"));var n=t.split("?");if(1===n.length)return t;var a=n.shift()+"?",i=[],o=[],s=function(e){if(!e)return{};var t={};return $.each(e.toString().split("&"),function(e,r){var n=r.split("=");n[0]&&(t[n[0]]=n[1]||"")}),t}(n.join("?"));return $.each(r,function(e,t){void 0!==s[t]&&(delete s[t],i.push(t))}),$.each(s,function(e,t){o.push(e+"="+t)}),(a+o.join("&")).replace(/[&?]+$/g,"").replace(/^(\/\/|http:\/\/)/,"https://")}e.skData=!1,e.sk=!1,e.tracking_id=!1,e.extensionId=!1,e.clearUrlParams=["priceBeautifyAB","transAbTest","traffic_analysisId","tracelog","trace","ws_ab_test","ws_test","aff_platform","sk","aff_trace_key","dp","af","cn","cv","cpt","spm","tpp","tp2","tp1","afref","btsid","algo_expid","algo_pvid","mall_affr","terminal_id","scm","src","scm_id","scm-url","s","_t","isOrigTitle","subid","subid1","gps-id","p4p","afref","rmsg","onelink_duration","onelink_status","onelink_failed_rewrite","onelink_score","onelink_thrd","onelink_item_to","onelink_item_from","onelink_page_to","onelink_page_from","tmLog"],e.init=function(){var t=$.Deferred();return $.when(E(),R(),A()).done(function(r,n,a){try{e.setSkData(r[0],r[1]),e.setExtensionId(n[0]),e.setTrackingId(a[0])}catch(e){X("AliPromLinks init error "+(e.message?e.message:""))}t.resolve(!0)}),t.promise()},e.setSkData=function(t,r){e.skData=r,e.sk=t},e.setExtensionId=function(t){e.extensionId=t},e.setTrackingId=function(t){e.tracking_id=t},e.setClrParams=function(t){t&&Array.isArray(t)&&t.length>0&&(e.clearUrlParams=t)},e.generateProm=function(a){var i,o,s,c,u;if("bg"===a.type){if(i=a.sk,o=a.skData,s=a.extensionId,c=a.tracking_id,u=a.href,!i||!o)return{result:u,clickId:""}}else if(i=a.sk||e.sk,o=a.skData||e.skData,s=a.extensionId||e.extensionId,c=a.tracking_id||e.tracking_id,u=a.href,!i||!o||!s)return{result:u,clickId:""};try{var l=t(u),d=decodeURIComponent(decodeURIComponent(l.href&&l.href.toString()||u.toString())),m="manual"===a.type?d:n(d),p=encodeURIComponent(encodeURI(m)),f=u,h=r(),g=o.urlPattern;return c||(c="prom0808"),i&&g&&p&&(f=g.replace("{sk}",i).replace("{clickId}",h).replace("{tracking_id}",c).replace("{exid}",s).replace("{target}",p)+l.hash),a.type,{result:f,clickId:h}}catch(e){return X("generateProm error "+(e.message?e.message:"")),{result:u}}},e.fixDeepLinkUrl=function(a){var i,o,s,c,u;if("bg"===a.type){if(i=a.sk,o=a.skData,s=a.extensionId,c=a.tracking_id,u=a.href,!i||!o)return{result:u,clickId:""}}else if(i=a.sk||e.sk,o=a.skData||e.skData,s=a.extensionId||e.extensionId,c=a.href||e.tracking_id,u=a.href,!i||!o||!s)return{result:u,clickId:""};try{var l=t(u),d=l.href||u,m=r(),p=decodeURIComponent(decodeURIComponent(d.toString())),f=n(d.toString()),h=o.paramsPattern,g=h.replace("{sk}",i).replace("{clickId}",m).replace("{tracking_id}",c).replace("{exid}",s);return i&&o&&h&&!p.match(/dl_target_url=(.*)?s\.click\.aliexpress\.com/g)&&p.match(/^(http.?:)?\/\/s\.click\.aliexpress\.com\/deep_link\.htm/g)&&(d=f.replace(/([?&]aff_short_key)=([^#&]*)/g,"$1="+g)),{result:d=d.replace(/^(http:)/,"https:")+l.hash,clickId:m}}catch(e){return X("fixDeepLinkUrl error "+(e.message?e.message:"")),{result:u}}}},T=new function(){var e=this;function t(){e.sessionExpiredTimestamp=!1,e.sessionTrialTimestamp=!1,e.sessionTrialMin=!1,e.sessionTrialMax=!1,e.sessionTimeout=!1,e.sessionStarted=!1,e.enabled=!1}function r(){if(chrome.runtime.lastError)return!1;if(!e.enabled)return!1;if((!1===e.sessionExpiredTimestamp||(new Date).getTime()>e.sessionExpiredTimestamp)&&!1===e.sessionTrialTimestamp){var t=function(e,t){var r,n;t>e&&(r=e,e=t,t=r);return n=e-.5+Math.random()*(t-e+1),n=Math.round(n)}(e.sessionTrialMin,e.sessionTrialMax);e.sessionTrialTimestamp=(new Date).getTime()+1e3*t,e.sessionStarted=!1,!1===e.sessionExpiredTimestamp||((new Date).getTime(),e.sessionExpiredTimestamp),n(!0)}else(new Date).getTime()<=e.sessionTrialTimestamp?(n(!1),e.sessionStarted=!1):(!1!==e.sessionTrialTimestamp&&(e.sessionTrialTimestamp=!1),(new Date).getTime()<=e.sessionExpiredTimestamp&&!e.sessionStarted&&(e.sessionStarted=!0))}function n(t){e.sessionExpiredTimestamp=(new Date).getTime()+1e3*e.sessionTimeout}t(),e.init=function(t){t?e.reloadSettings(t):C().done(function(t){e.reloadSettings(t)}),chrome.webRequest.onBeforeRequest.addListener(r,{urls:["*://*.aliexpress.com/*"],types:["main_frame"]})},e.reloadSettings=function(r){e.sessionTrialMin=!(!r||!r.sessionTrialMin)&&+r.sessionTrialMin,e.sessionTrialMax=!(!r||!r.sessionTrialMax)&&+r.sessionTrialMax,e.sessionTimeout=!(!r||!r.sessionTimeout)&&+r.sessionTimeout,e.sessionTrialMin&&e.sessionTrialMax&&e.sessionTimeout?e.enabled=!0:(t(),e.enabled=!1)},e.checkIfAllowed=function(){return!e.enabled||(!1!==e.sessionExpiredTimestamp&&(new Date).getTime()>e.sessionExpiredTimestamp&&(e.sessionExpiredTimestamp=!1,e.sessionStarted=!1),e.sessionStarted)}},I=new function(){var e=this;e.timeout=(new Date).getTime(),e.limiters=!1,e.init=function(){e.limiters||L().done(function(t,r,n){e.setLimiters(n&&n.limiters)})},e.checkIfAllowed=function(t){var r,n=!0;try{if((new Date).getTime()<e.timeout)n=!1;else if(e.limiters&&t.url){var a=!1,i=!1,o=0,s=t.url;if($.each(e.limiters,function(e,r){if(r.mask&&(-1!==s.search(new RegExp(r.mask))||r.ci&&t.initiatorPage&&-1!==t.initiatorPage.search(new RegExp(r.mask))))return a=r.mask,r.log&&(i=!0),r.int&&+r.int&&(o=+r.int),!1}),i&&a){var c={type:"doProductRedirect",tab_url:s,prom_url:s,logType:5,message:"limiter "+a+(o?" "+o+"s":"")};t.initiatorPage&&(c.initiatorPage=t.initiatorPage),a&&(c.limiter=a),N(c)}o&&(r=o,e.timeout=(new Date).getTime()+1e3*+r),a&&(n=!1)}}catch(e){X("sendSuccessOrderStat error "+(e.message?e.message:""))}return n},e.setLimiters=function(t){e.limiters=t}};if(void 0!==chrome.runtime.getManifest){var w=chrome.runtime.getManifest();b=w.version}_?(h={landHost:"http://aliexpress-helper.ru",dataHost:"https://aliexpress-checker.ru",welcome:"/welcome",remove:"/remove",settingsFile:"/settings.json",exceptionsFile:"/5bar65/data/exceptions.php",trackingIdPath:"/5bar65/data/trackingId.php",extensionIdPath:"/5bar65/data/extensionId.php",skPath:"/5bar65/b24hy.php",analyticsPath:"/5bar65/aliAnalytics.php",resetDefferedTimeout:25e3,globalAjaxTimeout:6e4,sendTrack:!0,redirectsLoopSendStat:!0,debug:!1},g={host:"https://plugin.aliexpress-checker.ru",clientKey:"107lh51iyenkogwkcw84o8ossk4osgcoogog08o4g0kk4kw0go",checkProd:"/api/1/items/",register:"/api/1/users/plugins",getList:"/api/1/watchlist",getProducts:"/api/1/item/list",getSeller:"/api/1/sellers/",getDelNotice:"/api/1/notice",addDeleteProd:"/api/1/watchlists/",updateProduct:"/api/1/items/",updateProductsArray:"/api/v2/items/hots",loadGogSimilar:"/similars/1/",getCurrency:"/api/1/currencies",sendSourceData:"/api/1/sources/",logs:"/api/1/logs"}):(h={landHost:"http://aliexpress-helper.ru",dataHost:"https://aliexpress-checker.ru",welcome:"/welcome",remove:"/remove",settingsFile:"/settings_dev.json",exceptionsFile:"/5bar65/data/exceptions.php",trackingIdPath:"/5bar65/data/trackingId.php",extensionIdPath:"/5bar65/data/extensionId.php",skPath:"/5bar65/b24hy.php",analyticsPath:"/5bar65/aliAnalytics.php?dev=1",resetDefferedTimeout:25e3,globalAjaxTimeout:6e4,sendTrack:!0,redirectsLoopSendStat:!0,debug:!0},g={host:"https://plugin.aliexpress-checker.ru",clientKey:"107lh51iyenkogwkcw84o8ossk4osgcoogog08o4g0kk4kw0go",checkProd:"/api/1/items/",register:"/api/1/users/plugins",getList:"/api/1/watchlist",getProducts:"/api/1/item/list",getSeller:"/api/1/sellers/",getDelNotice:"/api/1/notice",addDeleteProd:"/api/1/watchlists/",updateProduct:"/api/1/items/",updateProductsArray:"/api/v2/items/hots",loadGogSimilar:"/similars/1/",getCurrency:"/api/1/currencies",sendSourceData:"/api/1/sources/",logs:"/api/1/logs"});var D={timeout:4e3,attempts:4};if(chrome.runtime.onUpdateAvailable){function S(){v.init("on_update_available").done(function(){C().done(function(e){e&&void 0!==e.forceUpdate&&!0===e.forceUpdate&&chrome.runtime.reload()})})}chrome.runtime.onUpdateAvailable.hasListener(S)||chrome.runtime.onUpdateAvailable.addListener(S)}function U(e){var t={};e.category&&(t.eventCategory=e.category||"Other"),e.action&&(t.eventAction=e.action||"other"),e.label&&(t.eventLabel=e.label||"Other"),t.hitCallback=function(){},ga&&ga("send","event",t)}function C(){var e=$.Deferred();return v.get({settingsJson:!1,settingsJsonTimeout:!1},function(t){!1!==t.settingsJson?!1===t.settingsJsonTimeout||t.settingsJsonTimeout<(new Date).getTime()?"pending"===P().state()?e.resolve(t.settingsJson,"storage"):P().done(function(t){P(!0),e.resolve(t,"reload")}):e.resolve(t.settingsJson,"storage"):P(!1).done(function(t){e.resolve(t,"empty")}).fail(function(){e.reject({},"error")})}),e.promise()}function P(e,t){if(e)return P.result=void 0,!1;if(void 0!==P.result&&"rejected"!==P.result.state()&&!t)return P.result.promise();P.result=$.Deferred();var r=0;return function e(){r++;$.ajax({url:h.dataHost+h.settingsFile,type:"GET",crossDomain:!0,cache:!1,dataType:"json",async:!0}).done(function(e){if(!c(e))return!1;(function e(t){e.result=$.Deferred();var r=60*(void 0!==t.settingsLoadInterval?+t.settingsLoadInterval:15)*1e3;v.set({settingsJson:t,settingsJsonTimeout:(new Date).getTime()+r},function(){T.reloadSettings(t),e.result.resolve(t)});return e.result.promise()})(e).done(function(e){P.result.resolve(e)})}).fail(function(t,n,a){r<D.attempts&&0===t.status&&0===t.readyState?setTimeout(e,D.timeout*r):(setTimeout(function(){P.result.reject()},h.resetDefferedTimeout),Z("loadSettingsJson error"+(r>1?", attempt "+r:""),t,n,a,"",123))})}(),P.result.promise()}function L(){var e=$.Deferred();return v.get({exceptionsJson:!1,youtubeExceptionsJson:!1,exceptionsJsonTimeout:!1,exceptionsOtherData:!1},function(t){!1!==t.exceptionsJson?!1===t.exceptionsJsonTimeout||t.exceptionsJsonTimeout<(new Date).getTime()?"pending"===M().state()?e.resolve(t.exceptionsJson,t.youtubeExceptionsJson,t.exceptionsOtherData,"storage"):M().done(function(t,r,n){M(!0),e.resolve(t,r,n,"reload")}).fail(function(){e.reject({},"error")}):e.resolve(t.exceptionsJson,t.youtubeExceptionsJson,t.exceptionsOtherData,"storage"):M(!1).done(function(t,r,n){e.resolve(t,r,n,"empty")})}),e.promise()}function M(e,t){if(e)return M.result=void 0,!1;if(void 0!==M.result&&"rejected"!==M.result.state()&&!t)return M.result.promise();function r(e){var t;t=function(t){e&&(b&&(e.extensionVersion=b),e.timestamp=t);var r=0;!function t(){r++;$.ajax({url:h.dataHost+h.exceptionsFile,type:"post",data:e,dataType:"json",crossDomain:!0,cache:!1,async:!0}).done(function(e){if(!c(e))return!1;(function(e){var t=$.Deferred(),r=9e5,n=e.generalExceptions||!1,a=e.youtubeExceptions||!1,i=e.redirectsDisabled||!1,o=e.otherData||!1,s=e.trialPeriod||!1,c=e.hideLinksInPopup||!1,u=e.analyticsFromAliPage||!1;function l(e){v.set({exceptionsJsonTimeout:(new Date).getTime()+e},function(){})}return v.set({hideLinksInPopup:c,exceptionsJson:n,exceptionsOtherData:o,youtubeExceptionsJson:a,analyticsFromAliPage:u,redirectsDisabled:i,trialPeriod:s,exceptionsJsonTimeout:(new Date).getTime()+9e4},function(){C().done(function(e){void 0!==e.exceptionsLoadInterval&&(r=60*+e.exceptionsLoadInterval*1e3),l(r)}).fail(function(){l(r)}),y.init(!1),x.setClrParams(o&&o.clrParams),I.setLimiters(o&&o.limiters),t.resolve(n,a,o)}),t.promise()})(e).done(function(e,t,r){M.result.resolve(e,t,r)})}).fail(function(e,n,a){r<D.attempts&&0===e.status&&0===e.readyState?setTimeout(t,D.timeout*r):(setTimeout(function(){M.result.reject()},h.resetDefferedTimeout),Z("loadExceptionsJson error"+(r>1?", attempt "+r:""),e,n,a,"",122))})}()},v.get({exceptionsJsonFirstLoad:!1},function(e){var r;!1===e.exceptionsJsonFirstLoad?(r=(new Date).getTime(),v.set({exceptionsJsonFirstLoad:r},function(){t(r)})):t(e.exceptionsJsonFirstLoad)})}return M.result=$.Deferred(),$.when(O(),A(),R()).then(function(e,t,n){r({utm_url:"string"==typeof e?e:e[0],tracking_id:"string"==typeof t?t:t[0],extensionId:"string"==typeof n?n:n[0]})},function(){r({})}),M.result.promise()}function E(){var e=$.Deferred();return v.get({sk:!1,skData:!1,skTimeout:!1},function(t){!1!==t.sk&&!1!==t.skData?!1===t.skTimeout||t.skTimeout<(new Date).getTime()?"pending"===j().state()?e.resolve(t.sk,t.skData,"storage"):j().done(function(t,r){j(!0),e.resolve(t,r)}):e.resolve(t.sk,t.skData,"storage"):j(!1).done(function(t,r){e.resolve(t,r)}).fail(function(){e.reject({},"error")})}),e.promise()}function j(e,t){if(e)return j.result=void 0,!1;if(void 0!==j.result&&"rejected"!==j.result.state()&&!t)return j.result.promise();j.result=$.Deferred();var r=0;return function e(){r++;$.ajax({url:h.dataHost+h.skPath,type:"post",dataType:"json",data:{get_sk:1,extensionVersion:b},crossDomain:!0,cache:!1,async:!0,statusCode:{404:function(){}},success:function(e){if(!c(e))return!1;void 0!==e.sk?function(e,t){var r=$.Deferred(),n=2592e5;return v.set({sk:e,skData:t,skTimeout:(new Date).getTime()+9e4},function(){x.setSkData(e,t),r.resolve(e,t)}),C().done(function(e){void 0!==e.skLoadInterval&&(n=60*+e.skLoadInterval*1e3),a(n)}).fail(function(){a(n)}),r.promise();function a(e){v.set({skTimeout:(new Date).getTime()+e},function(){})}}(e.sk,e.skData).done(function(e,t){j.result.resolve(e,t)}):N({type:"pluginError",message:"loadSk no_sk",errorCode:114})},error:function(t,n,a){r<D.attempts&&0===t.status&&0===t.readyState?setTimeout(e,D.timeout*r):(setTimeout(function(){j.result.reject()},h.resetDefferedTimeout),Z("load sk error"+(r>1?", attempt "+r:""),t,n,a,"",121))}})}(),j.result.promise()}function A(e,t){if(void 0!==A.result&&"rejected"!==A.result.state()&&!t)return A.result.promise();A.result=$.Deferred();var r=(new Date).getTime()+432e6;function n(e){var t={get_tracking_id:1,utm_url:e||"empty"};b&&(t.extensionVersion=b);var n=0;!function e(){n++;$.ajax({url:h.dataHost+h.trackingIdPath,type:"post",dataType:"json",data:t,crossDomain:!0,cache:!1,async:!0,statusCode:{404:function(){}},success:function(e){if(!c(e))return N({type:"pluginError",message:"getTrackingId no_id in response",errorCode:125}),a(),!1;void 0!==e.tracking_id?(v.set({tracking_id:e.tracking_id,tracking_idTimeout:r},function(){x.setTrackingId(e.tracking_id),A.result.resolve(e.tracking_id)}),N({type:"getTrackingId",tracking_id:e.tracking_id?e.tracking_id:"",message:"ajax success"})):(a(),N({type:"pluginError",message:"getTrackingId no_id",errorCode:115}))},error:function(t,r,a){n<D.attempts&&0===t.status&&0===t.readyState?setTimeout(e,D.timeout*n):(A.result.reject({},"error"),Z("getTrackingId error"+(n>1?", attempt "+n:""),t,r,a,"",120))}})}()}function a(){v.set({tracking_id:"prom0808",tracking_idTimeout:r},function(){x.setTrackingId("prom0808"),A.result.resolve("prom0808"),N({type:"getTrackingId",tracking_id:response.tracking_id?response.tracking_id:"",message:"set default"})})}return v.get({tracking_id:!1,tracking_idTimeout:!1},function(t){if(!1!==t.tracking_id&&!1!==t.tracking_idTimeout&&(new Date).getTime()<t.tracking_idTimeout)return A.result.resolve(t.tracking_id,"storage"),!1;e?n(e):O().done(function(e){n(e)})}),A.result.promise()}function R(e){return void 0===R.result||"rejected"===R.result.state()||e?(R.result=$.Deferred(),v.get({extensionId:!1},function(e){if(!1!==e.extensionId)return x.setExtensionId(e.extensionId),R.result.resolve(e.extensionId,"storage"),!1;var t=0;!function e(){t++;$.ajax({url:h.dataHost+h.extensionIdPath,type:"post",dataType:"json",data:{get_extensionId:1},crossDomain:!0,cache:!1,async:!0,statusCode:{404:function(){}},success:function(e){if(!c(e))return!1;e.extensionId?(N({type:"loadExtensionId ",extensionId:e.extensionId,message:"loadExtensionId success"},!0),v.set({extensionId:e.extensionId,apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1},function(){x.setExtensionId(e.extensionId),R.result.resolve(e.extensionId,"ajax")})):N({type:"pluginError",message:"loadExtensionId no_id",errorCode:116},!0)},error:function(r,n,a){t<D.attempts&&0===r.status&&0===r.readyState?setTimeout(e,D.timeout*t):(R.result.reject({},"error"),Z("getOrLoadExtensionId error"+(t>1?", attempt "+t:""),r,n,a,"",112))}})}()}),R.result.promise()):R.result.promise()}function O(){return void 0!==O.result&&"pending"===O.result.state()?O.result.promise():(O.result=$.Deferred(),v.get({utm_url:!1},function(e){!1!==e.utm_url&&""!==e.utm_url?O.result.resolve(e.utm_url,"storage"):function(){var e=$.Deferred(),t=setTimeout(function(){a("no_url_timeout","no_url_timeout")},6e4);if(localStorage.getItem("utm_url"))(function(e){var t=$.Deferred();e||(e="no_url");return v.set({utm_url:e},function(){localStorage.removeItem("utm_url"),t.resolve(e)}),N({type:"writeOldUtm",old_utm:e,message:"localStorage utm exist in plugin"}),t.promise()})(localStorage.getItem("utm_url")).done(function(r){clearTimeout(t),e.resolve(r,"old_utm")});else{function r(){chrome.tabs?chrome.tabs.query({active:!0},function(e){chrome.runtime.lastError?n():e&&e[0]&&e[0].url?a(e[0].url,"active_tab"):n()}):a("no_url","no_chrome_tabs")}function n(){chrome.tabs.query({},function(e){var t=!1;$.each(e,function(e,r){if(-1===r.url.indexOf(h.landHost+h.welcome)&&-1===r.url.indexOf(h.landHost+h.remove)&&(-1!==r.url.indexOf("webstore/detail/aliexpress-helper/")||-1!==r.url.indexOf("aliexpress-helper.ru/")))return a(r.url,"all_tabs"),t=!0,!1}),t||$.each(e,function(e,r){return-1!==r.url.indexOf("chrome.google.com/webstore")?(a(r.url,"webstore"),t=!0,!1):-1!==r.url.indexOf(h.landHost.replace(/^http.?:\/\//,""))?(a(r.url,"land"),t=!0,!1):void 0}),t||a("no_url","no_url")})}function a(r,n){v.set({utm_url:r},function(){e.resolve(r,n),clearTimeout(t)})}chrome.cookies?chrome.cookies.get({url:h.landHost,name:"installUrl"},function(e){e&&e.value?a(decodeURIComponent(e.value),"land_cookie"):r()}):r()}return e.promise()}().done(function(e,t){O.result.resolve(e,t)})}),O.result.promise())}function J(e,t){if(!h.sendTrack||!e||1===e)return h.sendTrack,!1;var r=$.Deferred(),n=$.Deferred(),a=$.Deferred();return v.get({installed:!1,utm_url:!1,sk:!1,tracking_id:!1,extensionId:!1,cashbackUser:!1},function(e){n.resolve(e)}),chrome.storage.sync?chrome.storage.sync.get({installed:!1,syncExtensionId:!1},function(e){a.resolve(e)}):a.resolve({installed:!1}),$.when(n,a).then(function(n,a){if(!1===n.installed&&!1===a.installed){var i={url:encodeURIComponent(e),type:t,sk:n.sk,cashbackUser:n.cashbackUser,tracking_id:n.tracking_id};!1!==n.extensionId&&(i.extensionId=n.extensionId),!1!==a.syncExtensionId?i.syncExtensionId=a.syncExtensionId:chrome.storage.sync&&!1!==n.extensionId&&chrome.storage.sync.set({syncExtensionId:n.extensionId});var o=0;!function s(){o++;$.ajax({url:h.dataHost+"/track",type:"post",dataType:"json",data:i,crossDomain:!0,cache:!1,async:!0,statusCode:{404:function(){}},success:function(){var r={type:"sendInstallTrack",installUrl:encodeURIComponent(e),extensionId:n.extensionId,locale:chrome.i18n.getMessage("@@ui_locale"),message:"install tracked "+t};a.syncExtensionId&&(r.syncExtensionId=a.syncExtensionId),N(r)},complete:function(){v.set({installed:!0})},error:function(e,t,n){o<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*o):(r.reject({},"error"),Z("sendInstallTrack error"+(o>1?", attempt "+o:""),e,t,n,"",111))}})}()}}),r.promise()}function q(){chrome.runtime.setUninstallURL&&v.get({utm_url:!1,unistallUrl:!1,extensionId:!1},function(e){var t=!1;e.unistallUrl&&e.utm_url&&(e.extensionId&&-1===e.unistallUrl.indexOf(e.extensionId)&&(t=!0),e.unistallUrl.match(/([?&]utm)=([^#&]{1,})/g,"")||(t=!0),e.unistallUrl.length>254&&(t=!0)),!e.utm_url||e.unistallUrl&&!t||setTimeout(function(){var t="";function r(t){var r=h.landHost+h.remove+"?"+(t?t+"&":"")+"utm="+encodeURIComponent(e.utm_url);return r=r.slice(0,254),v.set({unistallUrl:r}),chrome.runtime.setUninstallURL(r)}R().done(function(e){e&&(t="extensionId="+e),r(t)}).fail(function(){r(t)})},1500)})}function N(e,t,r){if(!e)return!1;var n=this;!n.aliAnalyticsQueue&&(n.aliAnalyticsQueue=[]),!n.aliAnalyticsTimeout&&(n.aliAnalyticsTimeout=[]),v.get({sk:!1,utm_url:!1,tracking_id:!1,extensionId:!1,cashbackUser:!1,settingsJson:!1,clickId:!1},function(a){var i;switch(i=!1===a.settingsJson?{}:a.settingsJson,e.type){case"loadExtensionId":if(!0!==i.a_loadExtensionId)return!1;break;case"pluginError":if(!0!==i.a_pluginError)return!1;break;case"contentScriptError":if(!0!==i.a_contentScriptError)return!1;break;case"ajaxError":if(!0!==i.a_ajaxError_0_0&&e.status&&0==e.status.status&&0==e.status.state)return!1;if(!0!==i.a_ajaxError_0_0_timeout&&e.status&&0==e.status.status&&0==e.status.state&&("timeout"==e.status.text||"timeout"==e.errorStatus))return!1;if(!0!==i.a_ajaxError_0_0_error&&e.status&&0==e.status.status&&0==e.status.state&&("error"==e.status.text||"error"==e.errorStatus))return!1;if(!0!==i.a_ajaxErrorTimeout&&e.status&&("timeout"==e.status.text||"timeout"==e.errorStatus))return!1;if(!0!==i.a_responseInAjaxErrors&&void 0!==e.status&&void 0!==e.status.response&&(e.status.response=""),!0!==i.a_ajaxError)return!1;break;case"sendInstallTrack":if(!0!==i.a_sendInstallTrack)return!1;break;case"writeOldUtm":if(!0!==i.a_writeOldUtm)return!1;break;case"getPromFromServer":if(!0!==i.a_getPromFromServer)return!1;break;case"getTrackingId":if(!0!==i.a_getTrackingId)return!1;break;case"orderSkAnalytics":if(!0!==i.a_orderSkAnalytics)return!1;break;case"sendVisitTrack":if(!0!==i.a_sendVisitTrack)return!1;break;case"doProductRedirect":if(!0!==i.a_doProductRedirect)return!1;break;case"checkCookie":if(!0!==i.a_checkCookie)return!1;break;case"cashbackUser":if(!0!==i.a_cashbackUser)return!1;break;case"cashbackUserStat":if(!0!==i.a_cashbackUserStat)return!1;break;case"analyticsFromAliPage":if(!0!==i.a_analyticsFromAliPage)return!1}!0!==t&&(!e.utm_url&&a.utm_url&&(e.utm_url=a.utm_url),!e.tracking_id&&a.tracking_id&&(e.tracking_id=a.tracking_id),!e.extensionId&&a.extensionId&&(e.extensionId=a.extensionId),!e.sk&&a.sk&&(e.sk=a.sk),!e.cashbackUser&&!1!==a.cashbackUser&&(e.cashbackUser=a.cashbackUser),!e.clickId&&!1!==a.clickId&&(e.clickId=a.clickId),navigator.userAgent&&(e.userAgent=navigator.userAgent)),b&&(e.extensionVersion=b),r&&"object"==typeof r&&$.each(r,function(t,r){!0===r&&void 0!==a[t]&&(e[t]=a[t])});var o={aliAnalytics:!0,aliAnalyticsData:e};n.aliAnalyticsQueue.push({ajax:{url:h.dataHost+h.analyticsPath,type:"post",dataType:"json",data:o,crossDomain:!0,cache:!1,async:!0,timeout:i.ajaxTimeout?i.ajaxTimeout:h.globalAjaxTimeout,success:function(){},error:function(e,t,r){}},redirectsLoopSendStat:h.redirectsLoopSendStat}),n.aliAnalyticsTimeout&&clearTimeout(n.aliAnalyticsTimeout),n.aliAnalyticsTimeout=setTimeout(function e(){var t=n.aliAnalyticsQueue.shift();t&&t.ajax&&t.ajax.data&&t.ajax.data.aliAnalyticsData;if(!t)return!1;t.redirectsLoopSendStat&&$.ajax(t.ajax),n.aliAnalyticsQueue.length&&(n.aliAnalyticsTimeout=setTimeout(e,1e3))},3500)})}function B(e,t){if(!0===t){if(!0===B.onStart)return!1;B.onStart=!0}function r(e){-1!==B.tabsReloadQueue.indexOf(e)&&B.tabsReloadQueue.splice(B.tabsReloadQueue.indexOf(e),1)}function n(e){return-1!==B.tabsReloadQueue.indexOf(e)}function a(e,t){if(!e)return!1;function r(e,t){t.js&&$.each(t.js,function(t,r){r+" ",chrome.tabs.executeScript(e,{file:r},function(){chrome.runtime.lastError})}),t.css&&$.each(t.css,function(t,r){r+" ",chrome.tabs.insertCSS(e,{file:r},function(){chrome.runtime.lastError})})}t&&t.js?r(e,t):w&&w.content_scripts&&$.each(w.content_scripts,function(t,n){n.js&&n.matches&&chrome.tabs.query({url:n.matches},function(t){for(var a=0;a<t.length;a++)t[a].id===e&&r(e,n)})})}B.tabsReloadQueue||(B.tabsReloadQueue=[],chrome.tabs.onActivated.addListener(function(e){e.tabId&&n(e.tabId)&&(r(e.tabId),a(e.tabId))}),chrome.tabs.onRemoved.addListener(function(e){r(e)})),C().done(function(t){t&&!0===t.reloadContentScripts&&setTimeout(function(){w&&w.content_scripts&&$.each(w.content_scripts,function(e,t){t.js&&t.matches&&chrome.tabs.query({url:t.matches},function(e){for(var r=0;r<e.length;r++)e[r].active?a(e[r].id,t):e[r].id&&-1===e[r].url.indexOf("login.aliexpress.com")&&!n(e[r].id)&&B.tabsReloadQueue.push(e[r].id)})})},e)})}function F(e,t,r){v.get({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackId:!1,clickId:!1},function(n){function a(){v.set({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackId:!1,clickId:!1,lastPromotionUrl:!1,lastPromotionSet:!1,lastTmallPromotionSet:!1},function(){e(),G(n,t)})}!1!==n.cashbackUser?r?setTimeout(function(){a()},r):a():v.set({clickId:!1,lastPromotionUrl:!1,lastPromotionSet:!1,lastTmallPromotionSet:!1},function(){e()})})}function H(e){E().done(function(t,r){v.get({utm_url:!1,cashbackUser:!1},function(n){if(!1===t)return N({type:"checkCookie",utm_url:n.utm_url,message:"no sk writed on cookie check",errorCode:119}),!1;V("aeu_cid",function(n){var a=!1,i=!1;n&&-1===n.search(t)?(n=void 0!==(n=n.split("-"))[n.length-1]?n[n.length-1]:n,a=!0):n?a=!1:(a=!1,i=!0),a?v.set({clickId:!1,lastPromotionUrl:!1},function(){void 0!==e&&e(a,t,r,i,n||"")}):void 0!==e&&e(a,t,r,i,n||"")})})})}function V(e,t){var r=$.Deferred();return e?chrome.cookies.get({url:"https://aliexpress.com/",name:e},function(e){var n=e&&e.value?e.value:null===e&&null;r.resolve(n),t&&t(n)}):(r.resolve(null),t&&t(null)),r.promise()}function z(e,t,r){var n=e.url,a=e.tabId||e.id,i=new u;$.when(L(),V("aeu_cid")).done(function(e,o){void 0===r&&(r=o),e[0]&&(e=e[0]),v.get({cashbackUser:!1,extensionId:!1},function(o){if(!1===o.cashbackUser){if(!n)return!1;var s=!1,c=decodeURIComponent(decodeURIComponent(n)),u=!1,l=!1,d=!1;if(void 0!==y&&!0===y.inited&&y.existYtExceptionTab(a))y.removeYtExceptionTab(a),d="youtube",u="youtubeLinkException",s=!0;else{var m=e.data_for_disable_redirects;d="data_for_disable_redirects",void 0!==m.masks&&$.each(m.masks,function(e,t){if(Q(c,decodeURIComponent(t.val)))return s=!0,u=t.val,!1}),void 0!==m.sk&&$.each(m.sk,function(e,t){if(-1!==c.indexOf(decodeURIComponent(t.val))||r&&-1!==r.indexOf(decodeURIComponent(t.val)))return s=!0,l=t.val,!1})}return!0===s&&v.set({cashbackUser:1,cashbackUtmMatched:d,cashbackMaskMatched:u,cashbackSkMatched:l,cashbackId:o.extensionId+"-"+(new Date).getTime()},function(){N({type:"cashbackUser",message:"cashback mark writed (from plugin), utm: "+("data_for_disable_redirects"===d?"global":"youtubeLinkException"===u?"youtube":"none")+", mask: "+u+", sk: "+(l||"none"),cashbackUtmMatched:d,cashbackMaskMatched:u,cashbackSkMatched:l,cashbackId:o.extensionId+"-"+(new Date).getTime()})}),t(s),i.showTime("CheckExceptions time: "),s}return Y(),i.showTime("CheckExceptions time: "),!1})})}function Y(){$.when(L()).done(function(e){e[0]&&(e=e[0]),v.get({cashbackUser:!1,extensionId:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackId:!1},function(t){if(!1!==t.cashbackUser&&"youtubeLinkException"!==t.cashbackMaskMatched)if(!1===t.cashbackUtmMatched||!1===t.cashbackSkMatched&&!1===t.cashbackMaskMatched)v.set({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackStatSend:!1,cashbackId:!1},function(){});else{var r=!1,n=e.data_for_disable_redirects;t.cashbackMaskMatched&&void 0!==n.masks&&$.each(n.masks,function(e,n){if(-1!==t.cashbackMaskMatched.indexOf(decodeURIComponent(n.val)))return r=!0,!1}),t.cashbackSkMatched&&void 0!==n.sk&&$.each(n.sk,function(e,n){if(-1!==t.cashbackSkMatched.indexOf(decodeURIComponent(n.val)))return r=!0,!1}),r||v.set({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackStatSend:!1,cashbackId:!1},function(){G(t,"from_exceptions")})}else t.cashbackMaskMatched})})}function Q(e,t){var r=new RegExp("^(http.?:)?//([a-z0-9_.-]+)?"+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,"(.*)"));return null!==e.match(r)}function G(e,t){var r={type:"cashbackUser",message:"cashback_mark_removed_"+t,removed:1,cashbackUtmMatched:e.cashbackUtmMatched,cashbackMaskMatched:e.cashbackMaskMatched,cashbackSkMatched:e.cashbackSkMatched,cashbackId:e.cashbackId};e.clickId&&(r.clickId=e.clickId),N(r)}function W(e){var t=e.url,r=e.cb||function(){},n=e.bg||!1;v.get({cashbackUser:!1,hideLinksInPopup:!1},function(e){if(!1===e.cashbackUser&&!1===e.hideLinksInPopup){var a=x.generateProm({href:t,type:"manual"}),i=a&&a.result||t;chrome.tabs.create({url:i,active:!n},function(){a&&a.clickId?v.set({clickId:a.clickId},function(){r()}):r()}),N({type:"doProductRedirect",tab_url:t,prom_url:i,logType:7,message:"manual tab"})}else chrome.tabs.create({url:t,active:!n},r)})}function K(e,t){v.get({cashbackUser:!1,hideLinksInPopup:!1},function(r){if(!1===r.cashbackUser&&!1===r.hideLinksInPopup){var n=x.generateProm({href:e,type:"manual"}),a=n&&n.result||e;t(a)}else t(e)})}function X(e){N({type:"contentScriptError",message:e,errorCode:133})}function Z(e,t,r,n,a,i){var o={type:"ajaxError",errorStatus:r,status:{status:t.status,response:t.responseText,text:t.statusText,state:t.readyState,errorCode:i},errorThrown:n,message:e};i&&(o.errorCode=i),a&&(o.requestParams=a),N(o)}v.init("on_start").done(function(){C().done(function(e){var t,r,n,a;!1!==typeof e&&!0===e.enableGA&&e.gaCounter&&(t=window,r=document,t.GoogleAnalyticsObject="ga",t.ga=t.ga||function(){(t.ga.q=t.ga.q||[]).push(arguments)},t.ga.l=1*new Date,n=r.createElement("script"),a=r.getElementsByTagName("script")[0],n.async=1,n.src="https://www.google-analytics.com/analytics.js",a.parentNode.insertBefore(n,a),ga("create",e.gaCounter,"auto"),ga("set","checkProtocolTask",function(){}),A().done(function(e){ga("send","pageview","/"+e)}).fail(function(){ga("send","pageview","/")}))}),function(){function e(){v.get({installed:!1},function(e){B(!1===e.installed?2500:500,!0)})}chrome.permissions.contains({origins:["http://*/*","https://*/*"]},function(e){chrome.runtime.lastError;try{if(!e)try{U({category:"Plugin bg",action:"error",label:"Permissions error"})}catch(e){}}catch(e){}}),A(),P(),M(),E(),x.init(),I.init(),R().done(function(){!function(e){function a(){function e(t,r){if(r)return e.result=void 0,!1;if(void 0!==e.result&&"rejected"!==e.result.state())return e.result.promise();e.result=$.Deferred();var n=0,a=!1;return function r(){n++;var o=g.host+g.getCurrency;$.ajax({url:o,type:"get",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:t.apiAccessToken,ajaxUrl:o},success:function(t){if(!c(t))return!1;var r=!1;$.each(t,function(e,t){var n;if(!t[0]||!t[1]||!t[2])return!1;r||(r={}),r[t[0]]?r[t[0]][t[1]]=t[2]:((n={})[t[1]]=t[2],r[t[0]]=n)}),r?v.set({currencyRates:r},function(){var t;e.result.resolve(r),t=12e4,v.set({currencyLoadTimeout:(new Date).getTime()+t},function(){})}):e.result.resolve(!1)},error:function(s,c,u){n<D.attempts&&0===s.status&&0===s.readyState?setTimeout(r,D.timeout*n):a||401!=+s.status?("Unauthorized"!==u&&401!=+s.status||i(t).done(function(e){t=k(e,t)}),Z("getCurrencyRates error",s,c,u,{access_token:t.apiAccessToken,ajaxUrl:o},104),e.result.resolve(!1)):(i(t).done(function(e){t=k(e,t),r()}),a=!0)}})}(),e.result.promise()}R().done(function(t){chrome.runtime.onMessage.addListener(function(r,n,a){if(!r)return!1;switch(r.type){case"reloadContentScripts":B(0,!1),a(!1);break;case"getPromLink":K(r.url,function(e){a(e)});break;case"createPromTab":W({url:r.url,bg:r.bg});break;case"sendRedirectStat":N({type:"doProductRedirect",tab_url:r.tabUrl,prom_url:r.promUrl,logType:6,message:"manual click"});break;case"sendErrorAnalytics":N({type:"contentScriptError",message:r.message,prodId:r.prodId,tab_url:r.tab_url,errorCode:r.errorCode}),a(!1)}return v.get({apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1},function(n){function o(){var o,s,c,l,d="",m=r.currency?"currency="+r.currency:"",p={access_token:n.apiAccessToken,requestType:r.type},f=0,h=!1;switch(m&&(p.currency=r.currency,v.set({lastAliCurrency:r.currency})),r.type){case"isInited":a({isInited:!0});break;case"checkExpires":a({result:u(n)});break;case"registerPlugin":i(n).done(function(e){n=k(e,n),a({registered:!0,data:e})});break;case"sendErrorAnalytics":r.apiError&&y({message:r.apiError.message,params:r.apiError.params});break;case"getList":d=g.host+g.getList+(m?"?"+m:""),p.lang=r.lang,(s=function(){f++,$.ajax({url:d,type:"get",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:n.apiAccessToken,lang:r.lang},success:function(e){v.get({cashbackUser:!1,hideLinksInPopup:!1},function(t){!1===t.cashbackUser&&!1===t.hideLinksInPopup&&$.each(e,function(t,r){if(r&&r.item&&r.item.url){var n=x.generateProm({href:r.item.url,type:"manual"});e[t].item.promUrl=n&&n.result||r.item.url}}),a(e)})},error:function(e,t,r){f<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*f):h||401!=+e.status?(p.ajaxUrl=d,b("getList error"+(f>1?", attempt "+f:""),e,t,r,p,110,"product_ajax.api_watchlist.error"),"Unauthorized"!==r&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("ajax_error")):(i(n).done(function(e){n=k(e,n),s()}),h=!0)}})})();break;case"getProducts":r.ids&&0!==r.ids.length?(d=g.host+g.getProducts+"?access_token="+n.apiAccessToken+(m?"&"+m:""),r.lang&&(p.lang=r.lang,d+="&lang="+r.lang),d+="&ids="+r.ids.join(","),p.ajaxUrl=d,(s=function(){f++,$.ajax({url:d,type:"get",dataType:"json",cache:!1,async:!0,crossDomain:!0,success:function(e){v.get({cashbackUser:!1,hideLinksInPopup:!1},function(t){!1===t.cashbackUser&&!1===t.hideLinksInPopup&&$.each(e,function(t,r){if(r&&r.url){var n=x.generateProm({href:r.url,type:"manual"});e[t].promUrl=n&&n.result||r.url}}),a(e)})},error:function(e,t,r){f<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*f):h||401!=+e.status?(b("getProducts error"+(f>1?", attempt "+f:""),e,t,r,p,132,"product_ajax.api_item_list.error"),"Unauthorized"!==r&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("ajax_error")):(i(n).done(function(e){n=k(e,n),s()}),h=!0)}})})()):a(!1);break;case"getSeller":d=g.host+g.getSeller+r.seller_id,p.lang=r.lang,o=r.prodId,r.seller_id&&(s=function(){f++,$.ajax({url:d,type:"get",dataType:"json",cache:!1,async:!0,crossDomain:!0,timeout:2e4,data:{access_token:n.apiAccessToken,lang:r.lang},success:function(e){e&&e.rate&&null!==e.rate.result_score&&void 0!==e.rate.result_score&&e.rate.summary&&e.rate.text?(a(e),e.expired&&w({type:"expired",tmpRating:e})):(N({type:"contentScriptError",message:"no rating from api "+r.seller_id+", prod "+o,errorCode:124}),y({message:"product_data.api_sellers.error",params:{error:"no rating from api",seller_id:r.seller_id,item:o}}),w({type:"no_rating"}))},error:function(e,t,a){f<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*f):h||401!=+e.status?(p.ajaxUrl=d,p.seller_id=r.seller_id,"Unauthorized"!==a&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),404===e.status?w({type:"404"}):(b("getSeller error "+(f>1?", attempt "+f:""),e,t,a,p,109,"product_ajax.api_sellers.error"),w({type:"ajax_error"}))):(i(n).done(function(e){n=k(e,n),s()}),h=!0)}})})();break;case"checkProduct":o=r.prodId,d=g.host+g.checkProd+o+"?add-to-wishlist=0"+(m?"&"+m:""),p.lang=r.lang,(s=function(){f++,$.ajax({url:d,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:n.apiAccessToken,lang:r.lang,similar:!0===r.isSimilar},success:function(e){v.get({cashbackUser:!1,hideLinksInPopup:!1},function(t){if(!1===t.cashbackUser&&e&&e.item&&e.item.url&&!1===t.hideLinksInPopup){var r=x.generateProm({href:e.item.url,type:"manual"});e.item.promUrl=r&&r.result||e.item.url}a(e)})},error:function(e,t,r){f<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*f):h||401!=+e.status?(p.ajaxUrl=d,p.item=o,b("checkProduct error",e,t,r,p,108,"product_ajax.api_items.error"),"Unauthorized"!==r&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("ajax_error")):(i(n).done(function(e){n=k(e,n),s()}),h=!0)}})})();break;case"removeNotifications":v.get({notificationsData:!1},function(e){if(!1!==e.notificationsData&&e.notificationsData&&e.notificationsData.length>0){var t=[];if($.each(e.notificationsData,function(e,r){t.push(r.id)}),t.length>0){var r=_();r.remove(t)}}}),a(!1);break;case"addDelProduct":o=r.prodId,d=g.host+g.addDeleteProd+o+(m?"?"+m:""),(s=function(){f++,$.ajax({url:d,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:n.apiAccessToken},success:function(e){a(e)},error:function(e,t,r){f<D.attempts&&0===e.status&&0===e.readyState?setTimeout(s,D.timeout*f):h||401!=+e.status?(p.ajaxUrl=g.host+g.getDelNotice,p.item=o,b("addDelProduct error",e,t,r,p,106,"product_ajax.api_watchlists.error"),"Unauthorized"!==r&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("ajax_error")):(i(n).done(function(e){n=k(e,n),s()}),h=!0)}})})();break;case"updateProduct":if(!(o=r.prodId))return!1;d=g.host+g.updateProduct+o+"/hots"+(m?"?"+m:""),$.ajax({url:d,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:n.apiAccessToken},success:function(e){a(e)},error:function(e,t,r){p.ajaxUrl=d,p.item=o,b("updateProduct error",e,t,r,p,105,"product_ajax.api_items_hots.error"),"Unauthorized"!==r&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("")}});break;case"updateProductsArray":if(!(o=r.prodId))return!1;d=g.host+g.updateProductsArray+(m?"?"+m:""),$.ajax({url:d,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:{access_token:n.apiAccessToken,ids:r.ids},success:function(e){a(e)},error:function(e,t,s){p.ajaxUrl=d,p.item=o,p.ids=r.ids.join(","),b("updateProductsArray error",e,t,s,p,105,"product_ajax.api_v2_items_hots.error"),"Unauthorized"!==s&&401!=+e.status||i(n).done(function(e){n=k(e,n)}),a("")}});break;case"getCurrencyRates":(c=n,l=$.Deferred(),v.get({currencyRates:!1,currencyLoadTimeout:!1},function(t){!1===t.currencyRates||!1===t.currencyLoadTimeout||t.currencyLoadTimeout<(new Date).getTime()?e(c).done(function(e){l.resolve(e)}):(l.resolve(t.currencyRates),e(c,!0))}),l.promise()).done(function(e){a(e)});break;case"sendGaData":U({category:r.category,action:r.action,label:r.label}),a(!1);break;case"analyticsFromAliPage":N({type:"analyticsFromAliPage",aliData:r.data,extensionId:t},!0,{cashbackUser:!0}),a(!1);break;case"sendBgAjaxRequest":var T=r.params,I={oldSimilarProducts:"https://www.aliexpress.com/product/recommend.htm",newSimilarProducts:"https://gpsfront.aliexpress.com/getI2iRecommendingResults.do"}[r.urlType];void 0!==I&&I?(T.url=I,T.success=function(e){a({type:"success",responseParams:{response:e}})},T.error=function(e,t,r){a({type:"error",responseParams:{jqXHR:e,textStatus:t,errorThrown:r}})},$.ajax(T)):a({type:"error",responseParams:{jqXHR:{},textStatus:"noAjaxUrlMatched",errorThrown:""}})}function w(e){var t=r.seller_id,s=r.lang,c=0;function u(e){(function(e,t){var r=$.Deferred();return v.get({confJson:!1,uiLanguage:!1},function(n){if(!1===n.uiLanguage)return r.resolve(),!1;var a=n.confJson["conf_"+n.uiLanguage+".json"];if(void 0===a||!a)return r.resolve(),!1;C().done(function(n){if(n.ratingCalculateFromAli){var i=t.search(/var sellerInfoDTO = /);if(-1===i||-1===t.search(/id=\"store-info\"/))return r.resolve(),!1;try{if(i>-1){for(var o=t.substring(i).replace("var sellerInfoDTO =","").replace("var dsr =","").replace(/;/g,",").replace(/[\r\n\{\}\"]/g,""),s=o.indexOf("<\/script>"),c=(o=s>-1&&o.substring(0,s).split(",")).length,u={},l=0;l<c;l++){var d=o[l].split(":"),m=d[0].replace(/\s/g,""),p=d[1];m&&p&&(u[m]=p)}var f=function(t){var r=t.params,n=t.config,a=function(){for(var e=100,t=["communication","description","shipping_speed","feedback_score","negative_rate","neutral_rate","positive","since_month"],a=n.calculate,i=0;i<t.length;i++){var o=r[t[i]],s=1;switch(t[i]){case"communication":case"description":case"shipping_speed":var c=0,u=a.mark_penalty,l=u&&u["marks_ranges_"+t[i]],d=u&&u.count_multiplier,m=r[t[i]+"_count"];s=g(d,m),$.each(l,function(e,t){o<=t[0]&&o>=t[1]&&(c=(u.max_value-o)*t[2]*s)}),e-=c;break;case"feedback_score":break;case"negative_rate":case"neutral_rate":s=g(a[t[i]].count_multiplier,o),e-=o*s;break;case"positive":var p=a.low_reviews_penalty;s=r.positive_rate>=p.min_positive_rate?p.multiplier_positive:p.multiplier,o<=p.min&&(e-=(p.min-o)*s);break;case"since_month":var f=a.seller_age.min_months_for_penalty,h=0;s=g(a.seller_age.count_multiplier,o),h=o<=f?-Math.ceil(o*(f-o)*s/12):Math.ceil(o*s/12),e+=h}}return(e=Math.round(e))>100&&(e=100),e<0&&(e=0),e;function g(e,t){var r=1;return $.each(e,function(e,n){if(t<n[0])return r=n[1],!1}),r}}();return i(a)&&(a=0),{id:+e,rate:{summary:function(e){return{text:t("result"),small_text:t("level_trust"),class:t("level_trust_css")};function t(t){if("result"===t&&r.feedback_score<=n.min_feedback_score.min_feetback_to_show_warn)return n.min_feedback_score.text;if("level_trust"===t&&i(e))return n.low_level_trust.text;var a="";return $.each(o(n[t]),function(r,i){if(e>=i)return a=n[t][i].text,!1}),a}}(a),text:function(){var e={success:[],error:[],warning:[]};return t("since_month",r.since_month),t("feedback_score",r.feedback_score),!r.no_info&&t("positive_reviews",r.positive_rate),r.reviews_count<=n.no_reviews.min&&e[n.no_reviews.class].push(n.no_reviews.text),r.feedback_score<=n.min_feedback_to_show_info||r.no_info||(t("communication",r.communication),t("description",r.description),t("shipping_speed",r.shipping_speed)),e;function t(t,r){return $.each(o(n[t]),function(a,i){switch(t){case"communication":case"description":case"shipping_speed":case"since_month":if(r>=i)return e[n[t][i].class].push(n[t][i].text),!1;break;case"feedback_score":return!1;case"positive_reviews":if(r>=i)return e[n[t][i].class].push(n[t][i].text),!1;break;default:return!1}})}}(),result_score:a},score:a};function i(e){return e<=n.calculate.min_feedback_to_calculate||r.no_info}function o(e){return Object.keys(e).sort(function(e,t){return(e*=1)>(t*=1)?-1:e<t?1:0})}}({params:function(e){var t={shipping_speed:!1,communication:!1,description:!1,shipping_speed_count:!1,communication_count:!1,description_count:!1,feedback_score:!1,seller_since:!1,since_month:!1,positive:!1,neutral:!1,negative:!1,neutral_rate:!1,negative_rate:!1,reviews_count:!1,no_info:!1};return t.shipping_speed=r(e.shippingServiceEval)?parseFloat(+e.shippingServiceEval):0,t.communication=r(e.sellerServiceEval)?parseFloat(+e.sellerServiceEval):0,t.description=r(e.proDescEval)?parseFloat(+e.proDescEval):0,t.shipping_speed_count=r(e.shippingServiceCount)?parseFloat(+e.shippingServiceCount):0,t.description_count=r(e.proDescCount)?parseFloat(+e.proDescCount):0,t.communication_count=r(e.sellerServiceCount)?parseFloat(+e.sellerServiceCount):0,t.feedback_score=r(e.sellerScore)?n(e.sellerScore):0,t.seller_since=e.since,t.since_month=Math.round((Date.now()-Date.parse(t.seller_since))/1e3/2678400),t.positive=r(e.totalPositive)?n(e.totalPositive):0,t.neutral=r(e.totalNeutral)?n(e.totalNeutral):0,t.negative=r(e.totalNegative)?n(e.totalNegative):0,t.reviews_count=t.positive+t.neutral+t.negative,t.neutral_rate=t.reviews_count?t.neutral/t.reviews_count*100:0,t.negative_rate=t.reviews_count?t.negative/t.reviews_count*100:0,t.positive_rate=t.reviews_count?t.positive/t.reviews_count*100:0,t.no_info=!t.shipping_speed&&!t.communication&&!t.description||0===t.reviews_count,t.feedback_score||(t.feedback_score=t.reviews_count&&t.since_month?t.since_month+t.reviews_count-2*t.negative:0),t.feedback_score<0&&(t.feedback_score=0),t;function r(e){return void 0!==e&&!isNaN(+e)}function n(e){var t=e+"";return t=parseInt(t.replace(/\,/g,"")),isNaN(t)?0:t}}(u),config:a});r.resolve({rating:f})}}catch(e){r.resolve()}}else r.resolve()}).fail(function(){r.resolve()})}),r.promise()})(t,e).done(function(e){void 0!==e&&e?a(e.rating):l("no rating after calc in plugin")})}function l(r){e.tmpRating?(N({type:"contentScriptError",message:r+", type "+e.type+", prod "+o+", seller "+t,errorCode:130}),y({message:"product_data.sellers.error",params:{error:r+", type "+e.type,seller_id:t,item:o}}),a(e.tmpRating)):(N({type:"contentScriptError",message:"no rating from api and from ali, type "+e.type+", prod "+o+", seller "+t+", "+r,errorCode:131}),y({message:"product_data.sellers.error",params:{error:"no rating from api and from ali, type "+e.type+", "+r,seller_id:t,item:o}}),a())}!function r(){c++;$.ajax({url:"https://m.aliexpress.com/store/sellerInfo.htm?sellerAdminSeq="+t,dataType:"html",crossDomain:!0,success:function(r){if(r)if("404"===e.type||"expired"===e.type){var c=g.host+g.sendSourceData+t+"/sellers?lang="+s+"&access_token="+n.apiAccessToken;$.ajax({url:c,type:"post",contentType:"text/plain",cache:!1,async:!0,crossDomain:!0,data:r,success:function(n){n&&n.rate&&null!==n.rate.result_score&&void 0!==n.rate.result_score&&n.rate.summary&&n.rate.text?"404"===e.type&&a(n):(N({type:"contentScriptError",message:"no rating from source data, type "+e.type+", prod "+o+", seller "+t,errorCode:129}),y({message:"product_data.sellers.error",params:{error:"no rating from source data, type "+e.type,seller_id:t,item:o}}),"404"===e.type&&u(r))},error:function(a,o,s){b("sendSellerSource error",a,o,s,{ajaxUrl:c,seller_id:t,access_token:n.apiAccessToken},126,"product_ajax.api_sources_sellers.error"),"Unauthorized"!==s&&401!=+a.status||i(n).done(function(e){n=k(e,n)}),"404"===e.type&&u(r)}})}else u(r);else l("no seller html from ali")},error:function(e,t,n){c<D.attempts&&0===e.status&&0===e.readyState?setTimeout(r,D.timeout*c):l("ajax error when loading from ali")}})}()}}n.extensionId=t,"sendGaData"===r.type||!1!==n.apiAccessToken&&!u(n)||"registerPlugin"===r.type?o():i(n).done(function(e){n=k(e,n),o()})}),!0})}),function(e){var a=$.Deferred();function i(i,o){n=i;var c=$.Deferred();o||e?$.getJSON(chrome.extension.getURL("_locales/"+i+"/messages.json")).done(function(e){s=function(t){return e[t]&&e[t].message||chrome.i18n.getMessage(t)},c.resolve("initTranslation done")}).fail(function(){c.resolve("initTranslation fail")}):c.resolve("initTranslation correct language"),c.done(function(){$(".translate").each(function(){$(this).html(s($(this).attr("data-localize")))}),$(".translate--placeholder").each(function(){$(this).attr("placeholder",s($(this).attr("data-localize")))}),$(".ali-plugin-wrap").removeClass("loading"),$(".select-row--uiLanguage select").html(""),$.each(r,function(e,r){-1!==t.indexOf(r.lang)&&$(".select-row--uiLanguage select").append('<option value="'+r.lang+'" '+(n==r.lang?" selected":"")+">"+r.name+"</option>")}),a.resolve(i,"initTranslation done")})}return chrome.storage.local.get({uiLanguage:!1},function(e){var r=chrome.i18n.getMessage("@@ui_locale").split("_")[0],a=n;!1!==e.uiLanguage?i(a=e.uiLanguage,r&&a!==r):(a=void 0!==r&&-1!==t.indexOf(r)?r:chrome.runtime&&chrome.runtime.getManifest().default_locale?chrome.runtime.getManifest().default_locale:"ru",chrome.storage.local.set({uiLanguage:a},function(){i(a,r&&a!==r)}))}),a.promise()}().done(function(){var e=_();chrome.webNavigation&&chrome.webNavigation.onCompleted.addListener(function(t){void 0===t||0!==t.frameId||!t.tabId&&0!==t.tabId||e.check()})})}function i(e,t){if(i.result,void 0!==i.result&&"pending"===i.result.state())return i.result.promise();function r(r){var n={pluginToken:r,client_secret:g.clientKey,screen_width:window.screen.width,screen_height:window.screen.height,os:function(){var e="Unknown";function t(t,r,n){n=n||r,navigator[t]&&-1!==navigator[t].indexOf(r)&&(e=n)}return t("appVersion","X11","UNIX"),t("appVersion","Mac","MacOS"),t("appVersion","Linux"),t("userAgent","Linux"),t("platform","Linux"),t("appVersion","Win","Windows"),t("userAgent","Windows"),t("platform","Win","Windows"),t("oscpu","Windows"),e.toLowerCase()}(),user_agent:navigator.userAgent};t&&(n.start=1);var a=0;!function t(){a++;$.ajax({url:g.host+g.register,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:n,statusCode:{404:function(){}},success:function(e){if(e){var t=new Date(Date.now()+1e3*+e.expires_in),r={apiAccessToken:e.access_token,apiRefreshToken:e.refresh_token||!1,apiTokenExpires:t.getTime(),apiTokenType:e.token_type};v.set(r,function(){i.result.resolve(r)})}},error:function(n,o,s){a<D.attempts&&0===n.status&&0===n.readyState?setTimeout(t,D.timeout*a):(i.result.resolve(e),b("registerPlugin error"+(a>1?", attempt "+a:""),n,o,s,{pluginToken:r},103))}})}()}return i.result=$.Deferred(),e&&e.extensionId?r(e.extensionId):R().done(function(e){r(e)}),i.result.promise()}function u(e){return!1===e.apiAccessToken||(new Date).getTime()>=e.apiTokenExpires-2*h.globalAjaxTimeout}function k(e,t){return e&&void 0!==e.apiAccessToken&&(t.apiAccessToken=e.apiAccessToken,t.apiRefreshToken=e.apiRefreshToken,t.apiTokenExpires=e.apiTokenExpires,t.apiTokenType=e.apiTokenType),t}function _(){var e,t="https://www.aliexpress.com/",r=/OPR/.test(navigator.userAgent)||"object"==typeof opr,a=/YaBrowser/.test(navigator.userAgent),c=[],h={};return chrome.notifications.onButtonClicked&&chrome.notifications.onButtonClicked.addListener(function(e,t){y({id:e,button:t,type:"onButtonClicked"})}),chrome.notifications.onClicked.addListener(function(e){y({id:e,type:"onClicked"})}),chrome.notifications.onClosed.addListener(function(e,t){y({id:e,byUser:t,type:"onClosed"})}),{check:function(){v.get({settingsJson:!1},function(n){function i(n){v.get({notificationExpires:!1},function(i){!0===n.pushNotifications&&function(){if(!1===i.notificationExpires)return!0;return(new Date).getTime()>=i.notificationExpires}()&&v.get({showPush:!0},function(i){!0===i.showPush&&_(n).done(function(n){var i,o;n&&n.length>0&&(i=n,v.get({showPush:!0,uiCurrency:!1,uiLanguage:!1},function(n){try{var u=0,g="";if($.each(i,function(e,t){if(-1===c.indexOf(t.id)&&c.push(t.id),t.item&&t.item.id)try{var r=m(t,!0);r.priceChange&&r.priceChange<0&&(t.item.priceChange=r.priceChange,h[t.item.id]=t.item,u++)}catch(e){}}),u=Object.keys(h).length,!0===n.showPush&&u>0){var k,_,b=chrome.i18n.getMessage("manifest_name"),v=h[Object.keys(h)[0]],y=!1!==D(v);if(1===u)y?(_=s("n_price")+" "+S(v,!0)+" / ▼ "+D(v,!0)+" / "+f(-D(v),S(v),!0),b=s("short_name")+" — "+s("n_title_dropped_one")):_=S(v,!0)+" - "+s("n_price_dropped"),k={type:"basic",title:b,message:v.title.slice(0,70).trim()+"...",contextMessage:_,iconUrl:v.image_url.replace("640x640","50x50"),eventTime:Date.now(),isClickable:!0},g="one";else if(u>1&&u<6){var x=[],T=a?32:27;$.each(h,function(e,t){var r=y?"▼ "+D(t,!0):S(t,!0);x.push({title:t.title.slice(0,T).trim()+"...",message:r})}),b=y?s("short_name")+" — "+s("n_title_dropped_many"):p(u,[s("n_price_changed_down_1"),s("n_price_changed_down_2"),s("n_price_changed_down_3")],"_"),k={type:"list",title:b,message:s("n_price_changed"),iconUrl:chrome.extension.getURL("icons/48.png"),eventTime:Date.now(),isClickable:!0,items:x},g="two to five"}else{if(y){var I=0,w=0;$.each(h,function(e,t){!1!==D(t)&&(I+=D(t)),w+=S(t)}),b=s("short_name")+" — "+s("n_title_dropped_many"),_=s("n_for")+" "+D(v,!0,I)+" / "+f(-I,w,!0)}k={type:"basic",title:b,message:p(u,[s("n_price_changed_down_1"),s("n_price_changed_down_2"),s("n_price_changed_down_3")],"_"),iconUrl:chrome.extension.getURL("icons/48.png"),eventTime:Date.now(),isClickable:!0},_&&(k.contextMessage=_),g="more than five"}if(_&&-1!==_.indexOf("NaN"))return X("showNotifications error droppedTxt is NaN"),!1;function D(e,t,r){return r||void 0===e.priceChange||0===e.priceChange||(r=e.priceChange),!!r&&(t?d(l(e),Math.abs(Math.round(10*r.toFixed(1))/10),!0):Math.abs(+e.priceChange))}function S(e,t){var r=e.sale_price&&+e.sale_price||e.original_price&&+e.original_price;return t?d(l(e),r,!0):r}!function(n){r||(n.buttons=[{title:s("n_price_changed_button")}]),v&&v.url&&(e=v.url.replace(/^http.?:\/\/([a-z0-9_\.-]+)?aliexpress\.com\//,t));try{chrome.notifications.create(o||"priceNotification",n,function(){var e=chrome.runtime.lastError;e&&"Adding buttons to notifications is not supported."===e.message&&(delete n.buttons,chrome.notifications.create(n,function(){}))}),U({category:"Plugin content",action:"show",label:"Notification "+g})}catch(e){}}(k)}}catch(e){X("showNotifications error "+(e.message?e.message:""))}}))})})})}!1!==n.settingsJson?i(n.settingsJson):C().done(function(e){i(e)})})},remove:x};function _(e){var t=+new Date,r=_.timeout&&_.timeout<t;return _.result,void 0===_.result||"pending"!==_.result.state()&&r?(_.result=$.Deferred(),_.timeout=t+2e4,v.get({apiAccessToken:!1,apiTokenExpires:!1,extensionId:!1,uiCurrency:!1,uiLanguage:!1},function(t){function r(){try{var r={access_token:t.apiAccessToken,lang:t.uiLanguage||n,currency:t.uiCurrency||o},a=g.host+g.getDelNotice,s=0,c=!1;!function n(){s++;$.ajax({url:a,type:"get",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:r,success:function(t){var r,n=new Date,a=e&&e.noticeCheckInterval&&+e.noticeCheckInterval;a?r=n.getTime()+60*a*1e3:(n.setDate(n.getDate()+1),n.setHours(6,0,0,0),r=n.getTime()),v.set({notificationsData:t,notificationExpires:r},function(){_.result.resolve(t)})},error:function(e,o,u){s<D.attempts&&0===e.status&&0===e.readyState?setTimeout(n,D.timeout*s):c||401!=+e.status?(r.ajaxUrl=a,b("loadNotifications error"+(s>1?", attempt "+s:""),e,o,u,r,102,"product_ajax.api_notice_load.error"),"Unauthorized"!==u&&401!=+e.status||i(t).done(function(e){t=k(e,t)})):(i(t).done(function(e){t=k(e,t),n()}),c=!0)}})}()}catch(e){}}!1===t.apiAccessToken||u(t)?i(t).done(function(e){t=k(e,t),r()}):r()}),_.result.promise()):_.result.promise()}function y(r){var n=r.id;if("priceNotification"===n){var a="#helper_my_products";1===Object.keys(h).length&&(a="#open_price_history"),"onClicked"!==r.type&&"onButtonClicked"!==r.type||W({url:(e||t)+a,bg:!1,cb:function(){U({category:"Plugin content",action:"click",label:"Notification click"})}}),chrome.notifications.clear("priceNotification",function(){}),("onClicked"===r.type||"onButtonClicked"===r.type&&0==+r.button||"onClosed"===r.type&&!0===r.byUser)&&v.get({apiAccessToken:!1,apiTokenExpires:!1,extensionId:!1},function(e){!1===e.apiAccessToken||u(e)?i(e).done(function(t){e=k(t,e),x()}):x()})}}function x(e){var t=void 0!==e?e:c;v.get({apiAccessToken:!1},function(e){if(t.length>0){var r={access_token:e.apiAccessToken,ids:t};v.set({notificationsData:!1},function(){c=[],h={};var e=g.host+g.getDelNotice,t=0;!function n(){t++;$.ajax({url:e,type:"delete",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:r,success:function(e){},error:function(a,i,o){t<D.attempts&&0===a.status&&0===a.readyState?setTimeout(n,D.timeout*t):(r.ajaxUrl=e,b("notificationsRemoved error"+(t>1?", attempt "+t:""),a,i,o,r,101,"product_ajax.api_notice_remove.error"))}})}()})}})}}function b(e,t,r,n,a,i,o){if(Z(e,t,r,n,a,i),o){var s=a;s||(s={}),s.error=n||e||"other",y({message:o,params:s})}}function y(e){if(!e||!e.message&&!e.level)return!1;function t(t,r){function n(){var r=g.host+g.logs,n={access_token:t.apiAccessToken,level:e.level||"error",message:e.message};e.params&&"object"==typeof e.params&&(n.params=e.params,delete n.params.requestType,!1!==t.extensionId&&(n.params.extensionId=t.extensionId)),$.ajax({url:r,type:"post",dataType:"json",cache:!1,async:!0,crossDomain:!0,data:n,success:function(e){}})}r&&!0===r.sendErrorsToApi&&(!1===t.apiAccessToken||u(t)?i(t).done(function(e){t=k(e,t),n()}):n())}e||(e={}),v.get({settingsJson:!1,extensionId:!1,apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1},function(e){!1!==e.settingsJson?t(e,e.settingsJson):C().done(function(r){t(e,r)})})}v.get({apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1,extensionId:!1},function(t){i(t,!0).done(function(r){t=k(r,t),a(),e()})})}(e)}).fail(function(){var t;t=e,chrome.runtime.onMessage.addListener(function(e,t,r){switch(e.type){case"reloadContentScripts":B(0,!1);break;case"sendErrorAnalytics":N({type:"contentScriptError",message:e.message,prodId:e.prodId,tab_url:e.tab_url,errorCode:e.errorCode});break;case"createPromTab":W({url:e.url,bg:e.bg});break;case"getPromLink":K(e.url,function(e){r(e)});break;case"sendGaData":U({category:e.category,action:e.action,label:e.label});break;default:return r(!1),!1}return!0}),t()}),C().done(function(e){e&&(T.init(e),e.ajaxTimeout&&(h.globalAjaxTimeout=+e.ajaxTimeout,$.ajaxSetup({timeout:h.globalAjaxTimeout})),!0===e.clearCashbackOnNewSession?F(function(){y.init()},"on_plugin_load"):y.init()),function(){function e(e,t,r){if(void 0!==e&&0===e.frameId&&chrome.tabs&&(e.tabId||0===e.tabId)){var a=!1;try{var i=decodeURIComponent(decodeURIComponent(e.url));if(-1!==i.indexOf("mall.aliexpress")&&(a=!0,"other"===r&&-1!==i.search(/[а-яА-Я]/)))return!1}catch(e){}$.when(C(),R()).done(function(i,o){i[0]&&(i=i[0]),o[0]&&(o=o[0]);var s=/OPR/.test(navigator.userAgent)||"object"==typeof opr;if(!s&&!1===i.redirectsEnabled||s&&!1===i.redirectsEnabledOpera)return!1;v.get({cashbackUser:!1,sk:!1,tracking_id:!1,installTimestamp:!1,redirectsDisabled:!1,trialPeriod:!1},function(s){if(!1!==s.redirectsDisabled)return!1;var c=e&&e.initiator?e.initiator:"",u=s.trialPeriod||i.incubationPeriod;if(!1!==s.installTimestamp&&u&&(new Date).getTime()<s.installTimestamp+60*+u*1e3)return!1;if(!I.checkIfAllowed({url:e.url,initiatorPage:c}))return!1;if(!1===s.cashbackUser){var l=!1,d=void 0!==i.redirectTimeout?+i.redirectTimeout:5e3,m=this;if(m.doRedirect=!0,setTimeout(function(){m.doRedirect=!1},d),t){if(!(l=n(e.url,s.sk)))return!1;if(!T.checkIfAllowed())return!1}else if(!T.checkIfAllowed())return!1;chrome.tabs.get(e.tabId,function(){if(chrome.runtime.lastError)return!1;H(function(u,d,p,f,h){var g,_,b,y;function T(t,r,n){var i;(n=r+" "+n,!1!==d&&d)?"prod"===r||"other"===r?z(e,function(e){e||c((i=x.generateProm({href:t,sk:d,skData:p,tracking_id:s.tracking_id,extensionId:o,type:"bg"})).result,i.clickId)},h):"deep"===r&&z(e,function(t){t||c((i=x.fixDeepLinkUrl({href:e.url,sk:d,skData:p,tracking_id:s.tracking_id,extensionId:o,type:"bg"})).result,i.clickId)},h):getAndWriteSk();function c(t,r){a&&(n+=" tmall"),!0===m.doRedirect?(t!==e.url?k.check(function(n){n&&v.set({clickId:r,lastPromotionUrl:t},function(){chrome.tabs.update(e.tabId,{url:t},function(){!function(e){var t=new Date;e?v.set({lastTmallPromotionSet:t.getTime()}):v.set({lastPromotionSet:t.getTime()})}(a)})})}):n+=" same url",I(n,t,2,r)):I(n+=" cancelled by timeout",t,3,r)}}function I(t,r,n,a){var i={type:"doProductRedirect",tab_url:e.url,prom_url:r||"",logType:n,message:t};a&&(i.clickId=a),c&&(i.initiatorPage=c),N(i)}l||n(e.url,d)&&t&&void 0!==i.deeplinkRedirect&&!0===i.deeplinkRedirect?T(e.url,"deep","deeplink_page_redirect"):u&&void 0!==i.wrongCookieRedirect&&!0===i.wrongCookieRedirect?T(e.url,r,"wrong_param "+h+", redirect"):f&&void 0!==i.noCookieRedirect&&!0===i.noCookieRedirect?T(e.url,r,"no_param, redirect"):(g=void 0!==i.promotionTimeout?+i.promotionTimeout:15,_=g,b=function(t){t?z(e,function(){},h):T(e.url,r,"normal_redirect")},y=a,v.get({lastPromotionSet:!1,lastTmallPromotionSet:!1},function(e){var t=y?e.lastTmallPromotionSet:e.lastPromotionSet,r=new Date,n=!!(void 0!==t&&t&&t>=r.getTime()-(_?6e4*_:18e4));b(n)}))})})}else Y();void 0===i&&N({type:"pluginError",message:"no settings in plugin",errorCode:118})})})}}function t(){var e=this;function t(e){v.get({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackId:!1,clickId:!1,lastPromotionUrl:!1},function(t){$.when(V("aeu_cid"),V("xman_us_f")).done(function(r,n){!function(r,n){try{var a=r&&r.split("-").pop(),i={type:"orderSkAnalytics",url:e.tabUrl,order_sk:r,message:e.pageType+" page"+(e.totalString?", total "+e.totalString:""),finishOrderPage:"successOrder"===e.pageType,cashbackUser:t.cashbackUser,cashbackUtmMatched:t.cashbackUtmMatched,cashbackMaskMatched:t.cashbackMaskMatched,cashbackSkMatched:t.cashbackSkMatched,cashbackId:t.cashbackId};if(t.lastPromotionUrl&&-1!==t.lastPromotionUrl.indexOf("mall.aliexpress")&&(i.message+=", tmall"),e.curr&&(i.curr=e.curr.toLowerCase()),!1!==t.clickId&&t.clickId&&(i.clickId=t.clickId),e.total&&(i.total=e.total),e.orderIds&&(i.orderIds=e.orderIds),n)try{var o=decodeURIComponent(n).match(/{.*?}/),s="affiliateKey";o&&o[0]&&(o=JSON.parse(o[0]))&&o[s]&&o[s]!==a&&(i.message+=", xman - "+o[s]+(o.tp1?", "+o.tp1:""))}catch(e){}N(i),"successOrder"===e.pageType&&(C().done(function(e){void 0!==e&&!0===e.clearCashbackOnOrder?F(function(){},"after_order",2e4):void 0!==e&&!0===e.clearPromOnOrder&&function(e,t,r){r?setTimeout(function(){n()},r):n();function n(){v.set({clickId:!1,lastPromotionUrl:!1,lastPromotionSet:!1,lastTmallPromotionSet:!1},function(){e(),G(data,t)})}}(function(){},"after_order",5e3)}),U({category:"Plugin bg",action:"action",label:"Finish order page"+(!1!==t.cashbackUser?" cashback":"")}))}catch(t){X("sendSkOrderStat error "+(e&&e.pageType?e.pageType+" ":"")+(t.message?t.message:""))}}(r,n)})})}e.orderTotalsTmp={},chrome.webRequest&&chrome.webRequest.onBeforeRequest.addListener(function(r){try{if(r&&0===r.frameId&&(r.tabId||0===r.tabId)&&r.url){var n,a,i=e.orderTotalsTmp[r.tabId]||{},o=r.url.match(/[?&]orderIds=([^#&?]*)/);-1!==r.url.indexOf("payOnlineSuccess")&&o&&o[1]?n={orderIds:o[1],total:!!i.total&&i.total,curr:!!i.curr&&i.curr,totalString:!!i.totalString&&i.totalString}:r.requestBody&&r.requestBody.formData&&r.requestBody.formData.orderIds&&(a=r.requestBody.formData,n={total:!(!a.cashAmount||!a.cashAmount.length)&&a.cashAmount.join(),curr:!(!a.cashCurrency||!a.cashCurrency.length)&&a.cashCurrency.join(),orderIds:!(!a.orderIds||!a.orderIds.length)&&a.orderIds.join()}),n&&n.orderIds&&(n.pageType="successOrder",n.tabUrl=r.url,t(n),delete e.orderTotalsTmp[r.tabId])}}catch(e){X("sendSuccessOrderStat error "+(e.message?e.message:""))}},{urls:["*://*.aliexpress.com/order/payOnlineSuccess*","*://*.aliexpress.com/order/pay_online_result*"],types:["main_frame"]},["requestBody"]),chrome.webNavigation&&chrome.webNavigation.onDOMContentLoaded.addListener(function(r){if(void 0!==r&&0===r.frameId&&chrome.tabs&&(r.tabId||0===r.tabId)&&r.url){chrome.tabs.executeScript&&chrome.tabs.executeScript(r.tabId,{code:"function getOrderTotalDataFromAli(){try {var html = document.querySelector('body').innerHTML, totalInUsd = html.match(/totalOrderAmount4USD ?:['\"]?(.*?)['\"]?,/), result = {error: document.getElementsByClassName('error-page').length, totalString: (document.querySelector('#all-totalfee b') ? document.querySelector('#all-totalfee b').innerHTML.replace('&nbsp;', ' ') : false)};if(totalInUsd && totalInUsd[1] && !isNaN(+totalInUsd[1])){result.total = totalInUsd[1];result.curr = 'USD';}return result;} catch (e) {return {error: true}}}getOrderTotalDataFromAli();"},function(n){if(chrome.runtime.lastError);else{var a=n&&n[0]?n[0]:{},i={},o={};a&&!a.error&&(i={pageType:"confirmOrder",tabUrl:r.url},a.totalString&&(i.totalString=a.totalString,o.totalString=a.totalString),a.total&&a.curr&&(i.total=a.total,i.curr=a.curr,o.total=a.total,o.curr=a.curr),(o.totalString||o.total)&&(e.orderTotalsTmp[r.tabId]=o),t(i))}})}},{url:[{hostSuffix:"shoppingcart.aliexpress.com",pathPrefix:"/order/confirm_order"}],types:["main_frame"]}),chrome.tabs&&chrome.tabs.onRemoved.addListener(function(t){t&&delete e.orderTotalsTmp[t]})}function r(e){var t=!(e.toString().match(/deep_link\.htm/g)||e.toString().match(/login\.aliexpress\.com/g)||!(e.toString().match(/^(http.?:)?\/\/([a-z0-9_\.-]+)?aliexpress\.com\/.*?\-detail\.html/g)||e.toString().match(/^http.?:\/\/([a-z0-9_\.-]+)?aliexpress\.com\/store\/product\//g)||e.toString().match(/^(http.?:)?\/\/([a-z0-9_\.-]+)?aliexpress\.com\/item\//g)));return t}function n(e,t){var r=!!e.toString().match(/^(http.?:)?\/\/(s\.click\.aliexpress\.com\/deep_link\.htm|s\.click\.aliexpress\.com\/e\/)/g);return!0===r&&(r=-1===decodeURIComponent(e).toString().replace(/([?&]dl_target_url)=([^#&]*)/g,"").indexOf(t)),r}function a(e){var t=!!e.toString().match(/^(http.?:)?\/\/(s\.click\.aliexpress\.com\/deep_link\.htm|s\.click\.aliexpress\.com\/e\/)/g);return t}(function(){function e(){v.get({lastVisitTrackDate:!1},function(e){(function(e){var t=(new Date).setHours(0,0,0,0),r=!1;!1===e?r=!0:e<t&&(r=!0);return r})(e.lastVisitTrackDate)&&v.get({lastVisitTrackDate:!1,mini_popup_clicks:!1,cashbackId:!1,cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,uiLanguage:!1,uiCurrency:!1,lastAliCurrency:!1},function(e){var t=function(){var e=new Date;return v.set({lastVisitTrackDate:e.getTime()}),e}(),r={type:"sendVisitTrack",lastVisit:(!1!==e.lastVisitTrackDate?new Date(e.lastVisitTrackDate):new Date)||"",currentTime:t,message:"user visited ali",clicks:{mini_popup_clicks:e.mini_popup_clicks}};!1!==e.cashbackUser&&(r.cashbackId=e.cashbackId,r.cashbackUtmMatched=e.cashbackUtmMatched,r.cashbackMaskMatched=e.cashbackMaskMatched,r.cashbackSkMatched=e.cashbackSkMatched),!1!==e.uiLanguage&&(r.lang=e.uiLanguage),!1!==e.uiCurrency&&(r.curr=e.uiCurrency),!1!==e.lastAliCurrency&&(r.aliCurr=e.lastAliCurrency),N(r),U({category:"Plugin bg",action:"action",label:"Visit"})})})}chrome.webNavigation.onBeforeNavigate.addListener(function(t){e()},{url:[{hostSuffix:"aliexpress.com"}],types:["main_frame"]})})(),E().done(function(n,i){k||(k=new function(){var e=this;e.check=function(t,r){if(void 0===r&&(r=!1),r)return e.redirectsCount;e.redirectsCount&&void 0!==e.redirectsCount||(e.redirectsCount=0),C().done(function(r){var n=void 0!==r.redirectsMax&&r.redirectsMax?+r.redirectsMax:5;e.redirectsCount>=(void 0!==r.redirectsSendStat&&r.redirectsSendStat?+r.redirectsSendStat:3)&&(h.redirectsLoopSendStat=!1),++e.redirectsCount,e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(function(){if(e.redirectsCount>=n){var t=e.redirectsCount;H(function(e,n,a,i,o){r.a_redirectLoops&&N({type:"pluginError",redirectsCount:t,message:"redirects loop detected and cleared"+(e?", wrong cookie: "+o+" our "+n:""),wrong:e,errorCode:117})})}e.redirectsCount=0,h.redirectsLoopSendStat=!0},void 0!==r.redirectsLoopTimer&&r.redirectsLoopTimer?+r.redirectsLoopTimer:4e3),t(e.redirectsCount<n)})}}),new t;var o=["aliexpress.com/af/category","aliexpress.com/category","aliexpress.com/af/*html","aliexpress.com/promotion","aliexpress.com/price","aliexpress.com/popular","aliexpress.com/store/group","aliexpress.com/store/all-wholesale-products","aliexpress.com/store/sale-items","aliexpress.com/store/feedback-score","aliexpress.com/store/top-rated-products","aliexpress.com/store/new-arrivals","aliexpress.com/store/seller-store-story","best.aliexpress.com/","flashdeals.aliexpress.com/","techdiscovery.aliexpress.com/","sale.aliexpress.com/","group.aliexpress.com/","bestselling.aliexpress.com/","coupon.aliexpress.com/","plaza.aliexpress.com/","tmall.aliexpress.com/category","tmall.aliexpress.com/wholesale","brandzone.aliexpress.com/"],s=[];$.each(o,function(e,t){s.push("*://*."+t+"*")}),chrome.webRequest&&(!1===_&&chrome.webRequest.onBeforeRequest.addListener(function(e){e.url&&(-1!==e.url.indexOf("/not")?v.set({notificationExpires:!1,notificationData:!1},function(){}):-1!==e.url.indexOf("/reg")?v.set({apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1},function(){}):-1!==e.url.indexOf("/trial")?v.set({installTimestamp:(new Date).getTime()-1728e5},function(){}):-1!==e.url.indexOf("/tooltip")?v.set({similarTooltipClosed:!1},function(){}):-1!==e.url.indexOf("/curr")?v.set({currencyLoadTimeout:!1},function(){}):v.set({cashbackUser:!1,cashbackUtmMatched:!1,cashbackMaskMatched:!1,cashbackSkMatched:!1,cashbackStatSend:!1,cashbackId:!1,notificationExpires:!1,notificationData:!1,cashbackStatMasks:[],lastVisitTrackDate:!1,skTimeout:!1,tracking_idTimeout:!1,currencyRates:!1,currencyLoadTimeout:!1,checkTokenExpires:!1,apiAccessToken:!1,apiRefreshToken:!1,apiTokenExpires:!1,apiTokenType:!1,cachedPrices:!1,lastPromotionUrl:!1,clickid:!1,installTimestamp:!1},function(){}))},{urls:["*://t.cb.del/*"],types:["main_frame"]}),chrome.webRequest.onBeforeRequest.addListener(function(t){!a(t.url)&&r(t.url)&&e(t,!1,"prod")},{urls:["*://*.aliexpress.com/store/product*","*://*.aliexpress.com/item*","*://*.aliexpress.com/*-detail.html*"],types:["main_frame"]}),chrome.webRequest.onBeforeRequest.addListener(function(t){!a(t.url)&&!r(t.url)&&e(t,!1,"other")},{urls:s,types:["main_frame"]}),chrome.webRequest.onBeforeRequest.addListener(function(t){t.url&&e(t,!0,"deep")},{urls:["*://s.click.aliexpress.com/deep_link.htm*","*://s.click.aliexpress.com/e/*"],types:["main_frame"]}),C().done(function(e){e&&!1!==e.stopSubframeRedirects&&chrome.webRequest.onBeforeRequest.addListener(function(e){if(chrome.runtime.lastError)return!1;var t={type:"doProductRedirect",tab_url:e.url,prom_url:e.url,logType:4,message:"stop wrong subframe - "+e.type};return e.initiator&&(t.initiatorPage=e.initiator),N(t),{cancel:!0}},{urls:["*://s.click.aliexpress.com/deep_link.htm*","*://s.click.aliexpress.com/e/*"],types:["sub_frame","stylesheet","script","image","font","object","xmlhttprequest"]},["blocking"])})),chrome.webNavigation&&chrome.webNavigation.onBeforeNavigate.addListener(function(e){var t,n;0!==e.frameId||a(e.url)||r(e.url)||(t=e.url,n=!1,$.each(o,function(e,r){if(-1!==t.indexOf(r))return n=!0,!1}),n)||v.get({cashbackUser:!1,sk:!1,tracking_id:!1},function(t){!1===t.cashbackUser?z(e,function(){},""):Y()})},{url:[{hostSuffix:"aliexpress.com"}],types:["main_frame"]})})}()}),v.get({cachedPrices:!1},function(e){var t=!1;!1!==e.cachedPrices&&($.each(e.cachedPrices,function(r,n){Date.now()-new Date(n.date).getTime()>1728e5&&(delete e.cachedPrices[r],t=!0)}),t&&v.set(e))}),setTimeout(function(){v.get({importantDataCheckFirst:!1},function(e){!0===e.importantDataCheckFirst?v.get({utm_url:!1,sk:!1,tracking_id:!1,extensionId:!1,settingsJson:!1,exceptionsJson:!1},function(e){var t=[];for(var r in e)if(e.hasOwnProperty(r)&&(!1===e[r]||!e[r]))switch(t.push("no "+r),r){case"extensionId":R(!0).done(function(e){e&&N({type:"pluginError",message:"checkImportantData extensionId loaded",errorCode:127})});break;case"settingsJson":P(!1,!0).done(function(e){e&&"object"==typeof e&&Object.keys(e).length>0&&N({type:"pluginError",message:"checkImportantData settings loaded",errorCode:127})});break;case"exceptionsJson":M(!1,!0).done(function(e){e&&"object"==typeof e&&Object.keys(e).length>0&&N({type:"pluginError",message:"checkImportantData exceptions loaded",errorCode:127})});break;case"sk":j(!1,!0).done(function(e){e&&N({type:"pluginError",message:"checkImportantData sk loaded",errorCode:127})});break;case"tracking_id":A(!1!==e.utm_url&&e.utm_url,!0).done(function(e){e&&N({type:"pluginError",message:"checkImportantData tracking_id loaded",errorCode:127})})}t.length&&N({type:"pluginError",message:"checkImportantData "+t.join(", "),errorCode:113})}):v.set({importantDataCheckFirst:!0})})},8e4)}()}),chrome.runtime.onInstalled.addListener(function(t){v.init("on_installed").done(function(){t||(t={}),"install"===t.reason?(O().done(function(e,t){A().done(function(){J(e,t)}).fail(function(){J(e,t)}),q()}),v.get({startPage:!1},function(e){localStorage.startPage?v.set({startPage:!0,installTimestamp:(new Date).getTime()}):!1===e.startPage&&v.set({startPage:!0,installTimestamp:(new Date).getTime()},function(){setTimeout(function(){chrome.tabs.create({url:h.landHost+h.welcome})},1e3)})})):"update"===t.reason&&(j(),O().done(function(){q()}),v.set({configJsonTimeout:!1},function(){var t,r;t=$.Deferred(),r="conf_"+n+".json",chrome.storage.local.get({confJson:!1,configJsonTimeout:!1},function(n){function a(a){$.ajax({url:"https://aliexpress-checker.ru/"+r,type:"GET",data:{},crossDomain:!0,async:!0}).done(function(i){if(i&&c(i)){var o=n;!1===n.confJson&&(o.confJson={}),!1===n.configJsonTimeout&&(o.configJsonTimeout={}),o.confJson[r]=i,o.configJsonTimeout[r]=(new Date).getTime()+6e5,chrome.storage.local.set(o,function(){e.config=i,a&&t.resolve(i)})}else t.reject()}).fail(function(){t.reject()})}function i(){return!1!==n.confJson&&n.confJson[r]}function o(){e.config=n.confJson[r],t.resolve(n.confJson[r])}e.config?t.resolve(e.config):!1===n.configJsonTimeout||!n.configJsonTimeout[r]||n.configJsonTimeout[r]<(new Date).getTime()||!i()?i()?(o(),a(!1)):a(!0):o()}),t.promise()}),setTimeout(function(){U({category:"Plugin bg",action:"action",label:"Plugin update "+(b||"")})},1e4))})})}();